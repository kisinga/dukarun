<app-page-header title="Subscription Tiers" class="mb-6" />
@if (error()) {
  <div role="alert" class="alert alert-error mb-6">
    <span>{{ error() }}</span>
  </div>
}
<div class="card card-border bg-base-100 shadow mb-6">
  <div class="card-body">
    <h2 class="card-title text-base mb-4">Add tier</h2>
    <form (ngSubmit)="create()" class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <label class="form-control w-full">
          <span class="label"><span class="label-text">Code</span></span>
          <input type="text" class="input input-bordered w-full" [(ngModel)]="formModel.code" name="code" placeholder="e.g. basic" required />
        </label>
        <label class="form-control w-full">
          <span class="label"><span class="label-text">Name</span></span>
          <input type="text" class="input input-bordered w-full" [(ngModel)]="formModel.name" name="name" placeholder="e.g. Basic" required />
        </label>
      </div>
      <label class="form-control w-full">
        <span class="label"><span class="label-text">Description</span></span>
        <input type="text" class="input input-bordered w-full" [(ngModel)]="formModel.description" name="description" placeholder="Optional" />
      </label>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <label class="form-control w-full">
          <span class="label"><span class="label-text">Price monthly (cents)</span></span>
          <input type="number" class="input input-bordered w-full" [(ngModel)]="formModel.priceMonthly" name="priceMonthly" placeholder="0" min="0" />
        </label>
        <label class="form-control w-full">
          <span class="label"><span class="label-text">Price yearly (cents)</span></span>
          <input type="number" class="input input-bordered w-full" [(ngModel)]="formModel.priceYearly" name="priceYearly" placeholder="0" min="0" />
        </label>
      </div>
      <label class="form-control w-full max-w-xs">
        <span class="label"><span class="label-text">SMS limit per 30 days</span></span>
        <input type="number" class="input input-bordered w-full" [(ngModel)]="formModel.smsLimit" name="smsLimit" placeholder="0 = no limit" min="0" />
      </label>
      <button type="submit" class="btn btn-primary" [disabled]="saving()">
        @if (saving()) {
          <span class="loading loading-spinner loading-sm"></span>
        }
        Create tier
      </button>
    </form>
  </div>
</div>
@if (loading()) {
  <div class="flex items-center gap-2 text-base-content/70">
    <span class="loading loading-spinner loading-md"></span>
    <span>Loading tiersâ€¦</span>
  </div>
} @else {
  <div class="overflow-x-auto rounded-xl border border-base-300 bg-base-100 shadow">
    <table class="table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Price (mo / yr)</th>
          <th>SMS limit</th>
          <th>Active</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (t of tiers(); track t.id) {
          <tr [class.opacity-60]="!t.isActive">
            <td class="font-medium">{{ t.code }}</td>
            <td>{{ t.name }}</td>
            <td>{{ t.priceMonthly }} / {{ t.priceYearly }}</td>
            <td>
              @if (editingTier()?.id === t.id) {
                <div class="flex items-center gap-2">
                  <input type="number" class="input input-bordered input-sm w-24" [ngModel]="editSmsLimit()" (ngModelChange)="editSmsLimit.set($event)" min="0" />
                  <button type="button" class="btn btn-primary btn-sm" (click)="saveEditSmsLimit()" [disabled]="saving()">Save</button>
                  <button type="button" class="btn btn-ghost btn-sm" (click)="cancelEdit()">Cancel</button>
                </div>
              } @else {
                {{ t.smsLimit ?? 0 }} @if (t.smsLimit && t.smsLimit > 0) {
                  <button type="button" class="btn btn-ghost btn-xs ml-1" (click)="openEditSmsLimit(t)">Edit</button>
                } @else {
                  <button type="button" class="btn btn-ghost btn-xs ml-1" (click)="openEditSmsLimit(t)">Set</button>
                }
              }
            </td>
            <td>
              @if (t.isActive) {
                <span class="badge badge-success badge-sm">Yes</span>
              } @else {
                <span class="badge badge-ghost badge-sm">No</span>
              }
            </td>
            <td>
              @if (t.isActive) {
                <button type="button" class="btn btn-error btn-sm btn-outline" (click)="deactivate(t.id)" [disabled]="saving()">Deactivate</button>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
}
