# =====================================
# Dukarun Application Services
# =====================================
#
# This file contains only application services (backend, frontend, ml-trainer).
# Infrastructure services (databases, cache, observability) are in docker-compose.services.yml
# All images are built in CI (build-and-push.yml); no build: here so Coolify uses deploy-only path.
#
# Usage:
#   # Start infrastructure first:
#   docker compose -f docker-compose.services.yml up -d
#   # Then start applications:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down

services:
  # ========================================
  # Backend Service (Vendure)
  # ========================================
  backend:
    image: ghcr.io/kisinga/dukarun/backend:latest
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - dukarun_services_network
    environment:
      # Database configuration - uses service name from shared network
      DB_HOST: ${DB_HOST:-postgres_db}
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-vendure}
      DB_USERNAME: ${DB_USERNAME:-vendure}
      DB_PASSWORD: ${DB_PASSWORD:-vendure}
      DB_SCHEMA: ${DB_SCHEMA:-public}

      # Audit Log Database configuration (TimescaleDB) - uses service name
      AUDIT_DB_HOST: ${AUDIT_DB_HOST:-timescaledb_audit}
      AUDIT_DB_PORT: 5432
      AUDIT_DB_NAME: ${AUDIT_DB_NAME:-audit_logs}
      AUDIT_DB_USERNAME: ${AUDIT_DB_USERNAME:-audit_user}
      AUDIT_DB_PASSWORD: ${AUDIT_DB_PASSWORD:-audit_password}

      # Redis configuration - uses service name
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Application configuration
      NODE_ENV: ${NODE_ENV:-production}

      # Admin credentials
      SUPERADMIN_USERNAME: ${SUPERADMIN_USERNAME:-superadmin}
      SUPERADMIN_PASSWORD: ${SUPERADMIN_PASSWORD:-superadmin}
      # Super-admin app origin(s) for CORS (comma-separated if multiple). Default matches typical Docker/local access.
      SUPERADMIN_URL: ${SUPERADMIN_URL:-http://localhost:4201}

      # Security
      COOKIE_SECRET: ${COOKIE_SECRET:-default-secret-key}
      COOKIE_SECURE: ${COOKIE_SECURE:-false}

      # CORS configuration (set CORS_ORIGIN/FRONTEND_URL in env e.g. http://localhost:4200)
      CORS_ORIGIN: ${CORS_ORIGIN}
      FRONTEND_URL: ${FRONTEND_URL}

      # Asset storage
      ASSET_STORAGE_STRATEGY: ${ASSET_STORAGE_STRATEGY:-LocalAssetStorageStrategy}
      ASSET_UPLOAD_DIR: ${ASSET_UPLOAD_DIR:-/usr/src/app/static/assets}
      ASSET_URL_PREFIX: ${ASSET_URL_PREFIX}

      # Email configuration (optional)
      MAIL_TRANSPORT: ${MAIL_TRANSPORT:-SMTP}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM}

      # SMS Provider configuration
      SMS_PROVIDER: ${SMS_PROVIDER:-textsms}

      # TextSMS Configuration (default provider)
      TEXTSMS_API_KEY: ${TEXTSMS_API_KEY}
      TEXTSMS_PARTNER_ID: ${TEXTSMS_PARTNER_ID}
      TEXTSMS_SHORTCODE: ${TEXTSMS_SHORTCODE}

      # Push Notification Configuration (VAPID) - set VAPID_EMAIL in env e.g. mailto:admin@example.com
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_EMAIL: ${VAPID_EMAIL}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # ML Training configuration (URLs use Docker service names; override in .env only if needed)
      ML_TRAINER_URL: http://ml-trainer:3005
      ML_SERVICE_TOKEN: ${ML_SERVICE_TOKEN}
      ML_TRAINING_INTERVAL_MINUTES: ${ML_TRAINING_INTERVAL_MINUTES:-60}
      ML_TRAINING_COOLDOWN_HOURS: ${ML_TRAINING_COOLDOWN_HOURS:-4}

    volumes:
      - backend_assets:/usr/src/app/static/assets
      - backend_uploads:/usr/src/app/static/uploads
      # Note: .env file mount removed - env vars are passed directly via environment section
      # In platforms like Coolify/Kubernetes, env vars are passed directly, so file mount is not needed
    ports:
      - '127.0.0.1:${BACKEND_PORT:-3000}:3000'
      - '127.0.0.1:3002:3002'
    # Note: depends_on removed for external services (postgres_db, redis, timescaledb_audit)
    # Backend will retry connections gracefully if services are not yet ready
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

  # ========================================
  # Frontend Service (Angular + Nginx)
  # ========================================
  frontend:
    image: ghcr.io/kisinga/dukarun/frontend:latest
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - dukarun_services_network
    environment:
      # Backend connection - using service name from shared network
      BACKEND_HOST: backend
      BACKEND_PORT: ${BACKEND_PORT:-3000}

      # Additional frontend configuration
      NODE_ENV: ${NODE_ENV:-production}

    # ports:
    #   - '${FRONTEND_PORT:-4200}:4200'
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:4200/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========================================
  # Super Admin (Angular + Nginx, port 4201)
  # Image: same registry/prefix as backend/frontend (see .github/workflows/build-and-push.yml)
  # ========================================
  super-admin:
    image: ghcr.io/kisinga/dukarun/super-admin:latest
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - dukarun_services_network
    environment:
      # Same pattern as frontend: nginx proxies /admin-api to backend; app uses relative URL only.
      BACKEND_HOST: ${BACKEND_HOST:-backend}
      BACKEND_PORT: ${BACKEND_PORT:-3000}
    ports:
      - '127.0.0.1:4201:4201'
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:4201/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ========================================
  # ML Trainer (Teachable Machine runner, port 3005)
  # Backend calls this service at ML_TRAINER_URL (default http://ml-trainer:3005)
  # ========================================
  ml-trainer:
    image: ghcr.io/kisinga/dukarun/ml-trainer:latest
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - dukarun_services_network
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      ML_PORT: ${ML_PORT:-3005}
      # Backend URL uses Docker service name so ml-trainer can reach backend on the same network
      BACKEND_INTERNAL_URL: http://backend:3000
      ML_SERVICE_TOKEN: ${ML_SERVICE_TOKEN}
    ports:
      - '127.0.0.1:3005:3005'
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3005/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ========================================
# Networks
# ========================================
networks:
  dukarun_services_network:
    external: true
  # For Coolify: Change 'dukarun_services_network' to 'coolify' and enable "Connect to Predefined Network" in Coolify UI

# ========================================
# Volumes
# ========================================
volumes:
  backend_assets:
    driver: local

  backend_uploads:
    driver: local
