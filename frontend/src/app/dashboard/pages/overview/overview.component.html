<div class="space-y-3 sm:space-y-4 animate-stagger-children">
  <!-- Header — greeting + shift toolbar -->
  <div class="overview-header rounded-lg border border-base-300 bg-base-100 overflow-hidden">
    <div class="p-3 sm:p-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="flex-1 min-w-0">
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">{{ getGreeting() }}</h1>
          <p class="text-xs text-base-content/50">{{ getCurrentDate() }}</p>
        </div>

        <!-- Shift controls — open shift when closed -->
        <div class="flex items-center gap-2 flex-wrap">
          @if (!sessionOpen()) {
            <span class="badge badge-ghost badge-sm font-semibold">Closed</span>
            <button
              type="button"
              class="btn btn-primary btn-sm font-semibold"
              (click)="shiftModalTrigger.openOpenModal()"
            >
              Open shift
            </button>
          }

          <button
            class="btn btn-ghost btn-sm btn-square touch-manipulation"
            (click)="refresh()"
            [class.loading]="isLoading()"
            [disabled]="isLoading()"
            title="Refresh"
          >
            @if (!isLoading()) {
              <svg
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            }
          </button>
        </div>
      </div>
    </div>
    <!-- Quick Stats inline in header -->
    <div
      class="flex items-center gap-3 sm:gap-4 px-3 sm:px-4 py-2 text-xs text-base-content/50 border-t border-base-300/50 bg-base-200/30"
    >
      <span
        ><span class="font-bold text-base-content tabular-nums">{{ productCount() }}</span>
        products</span
      >
      <span class="w-px h-3 bg-base-300"></span>
      <span
        ><span class="font-bold text-base-content tabular-nums">{{ activeUsers() }}</span>
        users</span
      >
      <span class="w-px h-3 bg-base-300"></span>
      <span
        >Avg sale
        <span class="font-bold text-base-content tabular-nums">{{ averageSale() }}</span></span
      >
    </div>
  </div>

  <!-- Error -->
  @if (error()) {
    <div role="alert" class="alert alert-error alert-sm py-2.5 px-3 rounded-lg">
      <svg
        class="h-4 w-4 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="text-xs font-medium flex-1">{{ error() }}</span>
      <button class="btn btn-error btn-xs touch-manipulation" (click)="refresh()">Retry</button>
    </div>
  }

  <!-- Period Selector -->
  <div class="bg-base-200 rounded-lg overflow-x-auto">
    <div role="tablist" class="tabs tabs-box">
      @for (period of periods; track period.key) {
        <button
          role="tab"
          class="tab font-semibold text-sm"
          [class.tab-active]="selectedPeriod() === period.key"
          (click)="selectPeriod(period.key)"
        >
          {{ period.label }}
        </button>
      }
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="grid grid-cols-3 gap-2 sm:gap-3">
    @for (category of categories(); track category.type) {
      <button
        type="button"
        class="stat-card-overview text-left rounded-lg p-3 sm:p-4 border transition-all duration-150 touch-manipulation"
        [class.border-l-4]="true"
        [class.stat-card-sales]="category.type === 'sales'"
        [class.stat-card-purchases]="category.type === 'purchases'"
        [class.stat-card-expenses]="category.type === 'expenses'"
        [class.ring-1]="expandedCategory() === category.type"
        [class.ring-base-content/10]="expandedCategory() === category.type"
        (click)="toggleCategory(category.type)"
      >
        <span
          class="text-[10px] sm:text-xs font-semibold uppercase tracking-wide text-base-content/50 block mb-1"
        >
          {{ category.name }}
        </span>

        <p
          class="text-lg sm:text-xl lg:text-2xl font-bold tabular-nums leading-tight"
          [class.text-success]="category.type === 'sales'"
          [class.text-info]="category.type === 'purchases'"
          [class.text-error]="category.type === 'expenses'"
        >
          {{ getAmountForPeriod(category) }}
        </p>

        <div class="hidden sm:flex flex-wrap gap-x-3 gap-y-0.5 mt-2">
          @for (stat of getSecondaryStats(category); track stat.period) {
            <span class="text-[10px] text-base-content/40 tabular-nums">
              {{ stat.label }} {{ stat.amount }}
            </span>
          }
        </div>
      </button>
    }
  </div>

  <!-- Expanded Breakdown -->
  @if (expandedCategory(); as expanded) {
    @for (category of categories(); track category.type) {
      @if (category.type === expanded && category.accounts.length > 0) {
        <div class="rounded-lg overflow-hidden border border-base-300 bg-base-100">
          <div class="flex items-center justify-between px-4 py-3 border-b border-base-300">
            <span class="text-sm font-bold text-base-content/70">
              {{ category.name }} breakdown
            </span>
            <button
              class="btn btn-ghost btn-xs btn-square touch-manipulation"
              (click)="toggleCategory(category.type)"
            >
              <svg
                class="h-3.5 w-3.5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="divide-y divide-base-300/50">
            @for (account of category.accounts; track account.label) {
              <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center gap-2.5">
                  <span
                    class="w-7 h-7 rounded-lg text-[10px] font-bold flex items-center justify-center shrink-0"
                    [class.bg-success/10]="category.type === 'sales'"
                    [class.text-success]="category.type === 'sales'"
                    [class.bg-info/10]="category.type === 'purchases'"
                    [class.text-info]="category.type === 'purchases'"
                    [class.bg-error/10]="category.type === 'expenses'"
                    [class.text-error]="category.type === 'expenses'"
                  >
                    {{ account.label[0] }}
                  </span>
                  <span class="text-sm text-base-content/70">{{ account.label }}</span>
                </div>
                <span
                  class="font-bold text-sm tabular-nums"
                  [class.text-success]="category.type === 'sales'"
                  [class.text-info]="category.type === 'purchases'"
                  [class.text-error]="category.type === 'expenses'"
                >
                  {{ account.value }}
                </span>
              </div>
            }
          </div>
        </div>
      }
    }
  }

  <!-- Low Stock Alert -->
  @if (lowStockCount() > 0) {
    <button
      class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-warning/10 border border-warning/30 transition-colors touch-manipulation hover:bg-warning/15"
      (click)="navigateToInventory()"
    >
      <svg
        class="h-5 w-5 text-warning shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
        />
      </svg>
      <div class="flex-1 min-w-0 text-left">
        <p class="font-semibold text-sm">{{ lowStockCount() }} items low on stock</p>
      </div>
      <svg
        class="h-4 w-4 text-base-content/30 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
      </svg>
    </button>
  }

  <!-- Recent Activity -->
  @if (recentActivity().length > 0) {
    <div class="rounded-lg border border-base-300 overflow-hidden bg-base-100">
      <button
        class="w-full flex items-center justify-between px-4 py-3 hover:bg-base-200/50 transition-colors touch-manipulation"
        (click)="toggleRecentActivity()"
      >
        <span class="font-bold text-sm text-base-content/70">Recent activity</span>

        <div class="flex items-center gap-2">
          <span class="text-xs text-base-content/40 tabular-nums">{{
            recentActivity().length
          }}</span>
          <svg
            class="h-4 w-4 text-base-content/30 transition-transform duration-200"
            [class.rotate-180]="showRecentActivity()"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      @if (showRecentActivity()) {
        <div class="border-t border-base-300">
          @for (activity of recentActivity().slice(0, 8); track activity.id; let isLast = $last) {
            <div
              class="flex items-center justify-between px-4 py-3 transition-colors hover:bg-base-200/30"
              [class.border-b]="!isLast"
              [class.border-base-300/50]="!isLast"
            >
              <div class="flex items-center gap-2.5 flex-1 min-w-0">
                <span
                  class="w-7 h-7 rounded-lg text-[10px] font-bold flex items-center justify-center shrink-0"
                  [class.bg-success/10]="activity.type === 'Sale'"
                  [class.text-success]="activity.type === 'Sale'"
                  [class.bg-info/10]="activity.type === 'Purchase'"
                  [class.text-info]="activity.type === 'Purchase'"
                  [class.bg-error/10]="activity.type === 'Expense'"
                  [class.text-error]="activity.type === 'Expense'"
                >
                  {{ activity.type[0] }}
                </span>

                <div class="min-w-0 flex-1">
                  <span class="text-xs sm:text-sm font-medium truncate block text-base-content/80">
                    {{ activity.description }}
                  </span>
                  <span class="text-[10px] text-base-content/40">{{ activity.time }}</span>
                </div>
              </div>

              <span
                class="font-bold tabular-nums text-xs sm:text-sm shrink-0 ml-3"
                [class.text-success]="activity.amount.startsWith('+')"
                [class.text-error]="activity.amount.startsWith('-')"
              >
                {{ activity.amount }}
              </span>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
