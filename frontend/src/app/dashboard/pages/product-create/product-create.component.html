<!-- Product Creation -->
<div class="min-h-screen bg-gradient-to-b from-base-200 to-base-300/30 px-4 py-3 pb-32 lg:py-8 lg:pb-8">
  @if (isReady()) {
    <div class="max-w-lg lg:max-w-xl mx-auto" [formGroup]="productForm">
      <!-- Desktop card wrapper -->
      <div class="lg:bg-base-100 lg:rounded-2xl lg:shadow-lg lg:border lg:border-base-300/50 lg:p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="hidden lg:flex w-10 h-10 rounded-xl bg-primary/10 items-center justify-center">
              <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </div>
            <div>
              <h2 class="text-base sm:text-lg lg:text-xl font-semibold">
                @if (isEditMode()) {
                  Edit {{ productForm.get('name')?.value || 'Product' }}
                } @else {
                  New Item
                }
              </h2>
              <p class="hidden lg:block text-xs text-base-content/50">
                @if (currentStage() === 1) { Fill in the basics } @else { Set your prices }
              </p>
            </div>
          </div>
        </div>

        <!-- Progress steps -->
        <ul class="steps steps-horizontal w-full mb-4 lg:mb-6 text-xs">
          <li
            class="step cursor-pointer transition-all duration-200"
            [class.step-primary]="currentStage() >= 1"
            (click)="goToStage1()"
          >
            Details
          </li>
          <li
            class="step cursor-pointer transition-all duration-200"
            [class.step-primary]="currentStage() >= 2"
            (click)="goToStage2()"
          >
            Pricing
          </li>
        </ul>

        <!-- Stage 1: Item type, product basics & how it's sold -->
        @if (currentStage() === 1) {
          <div class="space-y-3 lg:space-y-4">
          <!-- Item type (product vs service) -->
          <app-item-type-selector [itemType]="itemType()" (itemTypeChange)="setItemType($event)" />

          <!-- Name field (for both products AND services) -->
          <app-product-name-input [nameControl]="nameControl" [itemType]="itemType()" />

          <!-- Product-specific options -->
          @if (itemType() === 'product') {
            <!-- How it's sold (presets) -->
            <app-how-sold-selector
              [selected]="howSoldPreset()"
              (selectedChange)="onHowSoldSelected($event)"
            />

            <!-- Size template (for multi-variant) - Hidden in edit mode since template is not stored in DB -->
            @if (!isEditMode()) {
              <app-size-template-selector
                [visible]="howSoldPreset() === 'multi-variant'"
                [selectedTemplate]="selectedSizeTemplate()"
                (templateChange)="onSizeTemplateChange($event)"
              />
            }

            <!-- Measurement unit (for measured presets) -->
            <app-measurement-unit-selector
              [measurementUnit]="measurementUnit()"
              [visible]="productType() === 'measured'"
              (unitChange)="setMeasurementUnit($event)"
            />
          }

          <!-- Identification -->
          <app-identification-selector
            #identificationSelector
            [identificationMethod]="identificationMethod()"
            [barcodeControl]="barcodeControl"
            [photoCount]="photoCount()"
            [hasValidIdentification]="hasValidIdentification()"
            (methodChange)="chooseIdentificationMethod($event)"
            (barcodeScanned)="onBarcodeScanned($event)"
            (photosChanged)="onPhotosChanged($event)"
          />

          <!-- Validation feedback -->
          @if (submitError() && currentStage() === 1) {
            <div class="alert alert-warning py-2">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-xs">{{ submitError() }}</span>
            </div>
          }

            <!-- Continue to Stage 2 -->
            <button
              type="button"
              class="btn btn-primary btn-block mt-3 lg:mt-4 gap-2"
              (click)="goToStage2()"
            >
              Continue
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m9 18 6-6-6-6"/>
              </svg>
            </button>
          </div>
        }

        <!-- Stage 2: Variants / SKUs, pricing & stock -->
        @if (currentStage() === 2) {
          <div class="space-y-3 lg:space-y-4">
          @if (itemType() === 'product') {
            <!-- Variant dimensions for products -->
            <app-variant-dimension-editor
              [variantDimensions]="variantDimensions()"
              [productType]="productType()"
              (addDimension)="addVariantDimension()"
              (removeDimension)="removeVariantDimension($event)"
              (updateOptions)="updateDimensionOptions($event.id, $event.options)"
            />

            <!-- Generated SKUs with pricing & opening stock -->
            <app-sku-list-editor [skus]="skus" [canRegenerate]="true" (regenerate)="generateSkus()" />
          }

          <!-- Service-specific form -->
          @if (itemType() === 'service') {
            <app-service-sku-editor [skuFormGroup]="firstSkuFormGroup" />
          }

          <!-- Validation Issues -->
          <app-validation-issues-panel [issues]="validationIssues()" />

            <!-- Location (bottom, just before create button) -->
            <app-location-display [location]="defaultLocation()" />
          </div>
        }

        <!-- Submit Button (Stage 2 only) -->
        @if (currentStage() === 2) {
          <div class="mt-4 lg:mt-6">
            <app-submit-bar
              [canSubmit]="canSubmit()"
              [isLoading]="isLoading()"
              [isEditMode]="isEditMode()"
              [itemType]="itemType()"
              [submitError]="submitError()"
              [submitSuccess]="submitSuccess()"
              (submit)="submitForm()"
              (previous)="goToStage1()"
            />
          </div>
        }
      </div>
    </div>
  } @else {
    <!-- Loading state while dashboard initializes -->
    <div class="flex justify-center items-center min-h-[50vh]">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }
</div>
