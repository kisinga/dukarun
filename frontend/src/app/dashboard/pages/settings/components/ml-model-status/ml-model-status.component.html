<div class="space-y-4">
  <!-- Header with Status -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h2 class="text-xl font-bold">ML Model</h2>
      <p class="text-sm text-base-content/60">Product recognition AI</p>
    </div>

    <!-- Quick Status Indicator -->
    @if (trainingInfo(); as info) {
      <div
        class="badge badge-lg gap-2"
        [class.badge-neutral]="info.status === 'idle'"
        [class.badge-info]="info.status === 'extracting' || info.status === 'training'"
        [class.badge-warning]="info.status === 'ready'"
        [class.badge-success]="info.status === 'active'"
        [class.badge-error]="info.status === 'failed'"
      >
        @if (info.status === 'extracting' || info.status === 'training') {
          <span class="loading loading-spinner loading-xs"></span>
        }
        {{ getStatusText(info.status) }}
      </div>
    } @else if (loading()) {
      <span class="loading loading-spinner loading-sm"></span>
    }
  </div>

  <!-- Main Status Card -->
  <div class="card bg-base-200">
    <div class="card-body p-4 gap-4">
      <!-- Progress Section -->
      @if (trainingInfo(); as info) {
        <!-- Progress Bar -->
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="font-medium">Progress</span>
            <span class="tabular-nums">{{ info.progress }}%</span>
          </div>
          <progress
            class="progress w-full"
            [class.progress-primary]="!isFailed()"
            [class.progress-error]="isFailed()"
            [value]="info.progress"
            max="100"
          ></progress>
        </div>

        <!-- Stats Row -->
        <div class="flex gap-6 text-sm">
          <div>
            <span class="text-base-content/60">Products</span>
            <span class="font-semibold ml-2">{{ info.productCount }}</span>
          </div>
          <div>
            <span class="text-base-content/60">Images</span>
            <span class="font-semibold ml-2">{{ info.imageCount }}</span>
          </div>
          @if (info.lastTrainedAt) {
            <div class="hidden sm:block">
              <span class="text-base-content/60">Last trained</span>
              <span class="font-semibold ml-2">{{ info.lastTrainedAt | date: 'short' }}</span>
            </div>
          }
        </div>

        <!-- Error Alert -->
        @if (info.error) {
          <div class="alert alert-error py-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="text-sm">{{ info.error }}</span>
          </div>
        }
      }

      <!-- Schema Error -->
      @if (error() && error()!.includes('not available')) {
        <div class="alert alert-warning py-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            />
          </svg>
          <span class="text-sm">Backend restart required to enable ML features</span>
        </div>
      }

      <!-- Actions -->
      <div class="flex flex-wrap gap-2">
        @if (isIdle() || isFailed()) {
          <button
            class="btn btn-primary btn-sm flex-1 sm:flex-none"
            [disabled]="loading()"
            (click)="extractPhotos()"
          >
            @if (loading()) {
              <span class="loading loading-spinner loading-xs"></span>
            } @else {
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                  clip-rule="evenodd"
                />
              </svg>
            }
            Prepare Data
          </button>
        }

        @if (isReady() || isActive()) {
          <button class="btn btn-outline btn-sm" (click)="downloadManifest()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
            Manifest
          </button>
        }

        <button class="btn btn-ghost btn-sm" [disabled]="loading()" (click)="refresh()">
          @if (loading()) {
            <span class="loading loading-spinner loading-xs"></span>
          } @else {
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                clip-rule="evenodd"
              />
            </svg>
          }
        </button>
      </div>
    </div>
  </div>

  <!-- Model Files - Collapsible on mobile -->
  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox" />
    <div class="collapse-title font-medium py-3 min-h-0">
      <div class="flex items-center justify-between">
        <span>Model Files</span>
        <div class="flex gap-1 mr-4">
          @if (mlModelAssets()?.mlModelJsonAsset) {
            <div class="w-2 h-2 rounded-full bg-success"></div>
          } @else {
            <div class="w-2 h-2 rounded-full bg-error"></div>
          }
          @if (mlModelAssets()?.mlModelBinAsset) {
            <div class="w-2 h-2 rounded-full bg-success"></div>
          } @else {
            <div class="w-2 h-2 rounded-full bg-error"></div>
          }
          @if (mlModelAssets()?.mlMetadataAsset) {
            <div class="w-2 h-2 rounded-full bg-success"></div>
          } @else {
            <div class="w-2 h-2 rounded-full bg-error"></div>
          }
        </div>
      </div>
    </div>
    <div class="collapse-content px-4 pb-4">
      <div class="grid gap-2">
        <!-- Model JSON -->
        <div class="flex items-center justify-between py-2 border-b border-base-300">
          <div>
            <div class="font-medium text-sm">Model JSON</div>
            <div class="text-xs text-base-content/60">Architecture</div>
          </div>
          @if (mlModelAssets()?.mlModelJsonAsset) {
            <div class="badge badge-success badge-sm">Ready</div>
          } @else {
            <div class="badge badge-ghost badge-sm">Missing</div>
          }
        </div>

        <!-- Weights -->
        <div class="flex items-center justify-between py-2 border-b border-base-300">
          <div>
            <div class="font-medium text-sm">Weights</div>
            <div class="text-xs text-base-content/60">Trained parameters</div>
          </div>
          @if (mlModelAssets()?.mlModelBinAsset) {
            <div class="badge badge-success badge-sm">Ready</div>
          } @else {
            <div class="badge badge-ghost badge-sm">Missing</div>
          }
        </div>

        <!-- Metadata -->
        <div class="flex items-center justify-between py-2">
          <div>
            <div class="font-medium text-sm">Metadata</div>
            <div class="text-xs text-base-content/60">Labels & config</div>
          </div>
          @if (mlModelAssets()?.mlMetadataAsset) {
            <div class="badge badge-success badge-sm">Ready</div>
          } @else {
            <div class="badge badge-ghost badge-sm">Missing</div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Help Section - Accordion -->
  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox" />
    <div class="collapse-title font-medium py-3 min-h-0">
      <div class="flex items-center gap-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 text-base-content/60"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
            clip-rule="evenodd"
          />
        </svg>
        <span>How it works</span>
      </div>
    </div>
    <div class="collapse-content text-sm">
      <div class="space-y-3 pt-2">
        <p class="text-base-content/70">
          Training happens automatically when you add or update product images. Use
          <strong>Prepare Data</strong> to manually refresh.
        </p>

        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="flex items-center gap-2">
            <div class="badge badge-neutral badge-xs">Idle</div>
            <span class="text-base-content/60">Ready to start</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-info badge-xs">Extracting</div>
            <span class="text-base-content/60">Processing</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-warning badge-xs">Ready</div>
            <span class="text-base-content/60">Queued</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-info badge-xs">Training</div>
            <span class="text-base-content/60">In progress</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-success badge-xs">Active</div>
            <span class="text-base-content/60">Ready to use</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="badge badge-error badge-xs">Failed</div>
            <span class="text-base-content/60">Error</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
