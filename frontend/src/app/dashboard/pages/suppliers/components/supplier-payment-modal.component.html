<!-- Supplier Payment Modal -->
<dialog #modal class="modal modal-bottom sm:modal-middle" (click)="onBackdropClick($event)">
  <div
    class="modal-box max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto p-4 sm:p-6"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between mb-4 pb-3 border-b border-base-300">
      <h3 class="text-lg font-bold text-base-content">Record Supplier Payment</h3>
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost" type="submit" aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </form>
    </div>

    @if (summaryLoading()) {
      <div class="flex justify-center py-6">
        <span class="loading loading-spinner loading-md"></span>
      </div>
    } @else if (summaryError()) {
      <div class="alert alert-error mb-4">
        <span class="text-sm">{{ summaryError() }}</span>
      </div>
      <div class="modal-action pt-4">
        <button type="button" class="btn btn-ghost w-full" (click)="onCancel()">Close</button>
      </div>
    } @else if (summary()) {
      <div class="mb-4 p-3 sm:p-4 bg-base-200 rounded-lg">
        <div class="text-sm sm:text-base font-semibold text-base-content mb-1">
          {{ supplierName() || 'Supplier' }}
        </div>
        <div class="text-xs text-base-content/70">{{ getOutstandingDisplay() }}</div>
      </div>

      @if (successResult()) {
        <div class="alert alert-success mb-4">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <div class="flex-1">
            <div class="font-semibold">Payment recorded successfully!</div>
            <div class="text-xs mt-1">
              Total allocated: {{ formatCurrency(successResult()!.totalAllocated) }}
              @if (successResult()!.purchasesPaid.length > 0) {
                <br />{{ successResult()!.purchasesPaid.length }} purchase(s) paid
              }
              @if (successResult()!.remainingBalance > 0) {
                <br />Remaining balance: {{ formatCurrency(successResult()!.remainingBalance) }}
              }
            </div>
          </div>
        </div>
      }

      @if (error()) {
        <div class="alert alert-error mb-4">
          <span class="text-sm">{{ error() }}</span>
        </div>
      }

      @if (!successResult()) {
        <form (ngSubmit)="onSubmit()" class="space-y-4">
          <div class="form-control">
            <label class="label" for="paymentAmount">
              <span class="label-text font-semibold">Payment Amount</span>
              <span class="label-text-alt text-error">Required</span>
            </label>
            <div class="relative">
              <input
                id="paymentAmount"
                type="number"
                step="0.01"
                min="0.01"
                placeholder="0.00"
                [value]="paymentAmount() ?? ''"
                (input)="paymentAmount.set(+$any($event.target).value || null)"
                class="input input-bordered w-full text-lg font-semibold"
                [class.input-error]="error() && (!paymentAmount() || paymentAmount()! <= 0)"
                [disabled]="isSubmitting()"
                autofocus
              />
            </div>
            @if ((summary()?.outstandingAmount ?? 0) > 0) {
              <label class="label">
                <span class="label-text-alt text-base-content/60">
                  Outstanding: {{ formatCurrency(summary()!.outstandingAmount) }}
                </span>
              </label>
            }
          </div>

          <div class="form-control">
            <label class="label" for="referenceNumber">
              <span class="label-text font-semibold">Reference Number</span>
              <span class="label-text-alt text-error">Required</span>
            </label>
            <input
              id="referenceNumber"
              type="text"
              placeholder="Enter reference number"
              [value]="refNumber"
              (input)="refNumber = $any($event.target).value"
              name="referenceNumber"
              class="input input-bordered w-full"
              [class.input-error]="error() && (!refNumber || refNumber.trim().length === 0)"
              [disabled]="isSubmitting()"
              required
            />
          </div>

          <div class="modal-action pt-4 flex-col gap-2">
            <button
              type="submit"
              class="btn btn-primary w-full"
              [class.loading]="isSubmitting()"
              [disabled]="isSubmitting()"
            >
              @if (!isSubmitting()) {
                Record Payment
              } @else {
                Processing...
              }
            </button>
            <button
              type="button"
              class="btn btn-ghost w-full"
              (click)="onCancel()"
              [disabled]="isSubmitting()"
            >
              Cancel
            </button>
          </div>
        </form>
      } @else {
        <div class="modal-action pt-4 flex-col gap-2">
          <button type="button" class="btn btn-primary w-full" (click)="onCancel()">Close</button>
        </div>
      }
    }
  </div>

  <form method="dialog" class="modal-backdrop">
    <button type="submit">close</button>
  </form>
</dialog>
