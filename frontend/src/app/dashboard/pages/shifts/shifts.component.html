<div class="space-y-6 anim-stagger">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <h2 class="text-lg font-semibold">Shifts</h2>
      <p class="text-sm text-base-content/60 mt-0.5">Monitor cashier sessions</p>
    </div>
    <button
      type="button"
      class="btn btn-ghost btn-sm btn-square"
      (click)="load()"
      [class.loading]="reconciliationsLoading()"
      title="Refresh"
    >
      @if (!reconciliationsLoading()) {
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          />
        </svg>
      }
    </button>
  </div>

  @if (error(); as err) {
    <div role="alert" class="alert alert-error">
      <span class="flex-1">{{ err }}</span>
      <button type="button" class="btn btn-sm" (click)="load()">Retry</button>
    </div>
  }

  <!-- Current session status -->
  <div class="card card-border bg-base-200/50">
    <div class="card-body">
      <h3 class="card-title text-base">Current shift</h3>
      @if (hasActiveSession()) {
        <p class="text-sm text-success font-medium">Open</p>
        @if (currentSession(); as session) {
          <p class="text-sm text-base-content/70">Opened {{ formatDateTime(session.openedAt) }}</p>
          <div class="mt-4">
            <p class="text-sm font-medium text-base-content/80 mb-2">
              Opening reconciliation (variances at open)
            </p>
            @if (loadingCurrentOpeningDetails()) {
              <div class="flex items-center gap-2 text-base-content/70">
                <span class="loading loading-spinner loading-sm"></span>
                Loading…
              </div>
            } @else if (currentSessionOpeningDetails() !== null) {
              @let details = currentSessionOpeningDetails();
              @if (details && details.length > 0) {
                <div class="overflow-x-auto">
                  <table class="table table-sm table-zebra">
                    <thead>
                      <tr>
                        <th>Account</th>
                        <th>Code</th>
                        <th>Expected</th>
                        <th>Declared</th>
                        <th>Variance</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (d of details; track d.accountId) {
                        <tr [class.bg-warning/10]="d.varianceCents && d.varianceCents !== '0'">
                          <td>{{ d.accountName }}</td>
                          <td class="font-mono text-sm">{{ d.accountCode }}</td>
                          <td>{{ formatCents(d.expectedBalanceCents) }}</td>
                          <td>{{ formatCents(d.declaredAmountCents) }}</td>
                          <td>
                            @if (d.varianceCents && d.varianceCents !== '0') {
                              <span class="font-semibold text-warning">{{
                                formatCents(d.varianceCents)
                              }}</span>
                            } @else {
                              {{ formatCents(d.varianceCents) }}
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              } @else {
                <p class="text-sm text-base-content/60">No opening reconciliation data.</p>
              }
            }
          </div>
        }
      } @else {
        <p class="text-sm text-base-content/60">
          No open shift. Open a shift from the dashboard overview.
        </p>
      }
    </div>
  </div>

  <!-- Reconciliation history (shared with accounting ledger tab) -->
  <div class="card card-border">
    <div class="card-body">
      <h3 class="card-title text-base">Reconciliation history</h3>
      <p class="text-base-content/70 text-sm">
        All reconciliation events: opening shift, closing shift, and manual reconciliations.
      </p>
      <app-reconciliation-history
        [context]="reconciliationHistoryContext()"
        (pageChange)="onReconciliationPageChange($event)"
      />
    </div>
  </div>

  <p class="text-sm text-base-content/60">
    <a
      routerLink="/dashboard/accounting/ledger"
      [queryParams]="{ tab: 'reconciliation' }"
      class="link link-hover"
    >
      View reconciliation history in Accounting →
    </a>
  </p>
</div>
