<div class="space-y-6 anim-stagger">
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1 min-w-0">
      <h2 class="text-lg font-semibold">Shifts</h2>
      <p class="text-sm text-base-content/60 mt-0.5">Monitor cashier sessions</p>
    </div>
    <button
      type="button"
      class="btn btn-ghost btn-sm btn-square"
      (click)="load()"
      [class.loading]="sessionsLoading()"
      title="Refresh"
    >
      @if (!sessionsLoading()) {
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          />
        </svg>
      }
    </button>
  </div>

  @if (error(); as err) {
    <div role="alert" class="alert alert-error">
      <span class="flex-1">{{ err }}</span>
      <button type="button" class="btn btn-sm" (click)="load()">Retry</button>
    </div>
  }

  <!-- Current session status -->
  <div class="card card-border bg-base-200/50">
    <div class="card-body">
      <h3 class="card-title text-base">Current shift</h3>
      @if (hasActiveSession()) {
        <p class="text-sm text-success font-medium">Open</p>
        @if (currentSession(); as session) {
          <p class="text-sm text-base-content/70">Opened {{ formatDateTime(session.openedAt) }}</p>
          <div class="mt-4">
            <p class="text-sm font-medium text-base-content/80 mb-2">
              Opening reconciliation (variances at open)
            </p>
            @if (loadingCurrentOpeningDetails()) {
              <div class="flex items-center gap-2 text-base-content/70">
                <span class="loading loading-spinner loading-sm"></span>
                Loading…
              </div>
            } @else if (currentSessionOpeningDetails() !== null) {
              @let details = currentSessionOpeningDetails();
              @if (details && details.length > 0) {
                <div class="overflow-x-auto">
                  <table class="table table-sm table-zebra">
                    <thead>
                      <tr>
                        <th>Account</th>
                        <th>Code</th>
                        <th>Expected</th>
                        <th>Declared</th>
                        <th>Variance</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (d of details; track d.accountId) {
                        <tr [class.bg-warning/10]="d.varianceCents && d.varianceCents !== '0'">
                          <td>{{ d.accountName }}</td>
                          <td class="font-mono text-sm">{{ d.accountCode }}</td>
                          <td>{{ formatCents(d.expectedBalanceCents) }}</td>
                          <td>{{ formatCents(d.declaredAmountCents) }}</td>
                          <td>
                            @if (d.varianceCents && d.varianceCents !== '0') {
                              <span class="font-semibold text-warning">{{
                                formatCents(d.varianceCents)
                              }}</span>
                            } @else {
                              {{ formatCents(d.varianceCents) }}
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              } @else {
                <p class="text-sm text-base-content/60">No opening reconciliation data.</p>
              }
            }
          </div>
        }
      } @else {
        <p class="text-sm text-base-content/60">
          No open shift. Open a shift from the dashboard overview.
        </p>
      }
    </div>
  </div>

  <!-- Shift history -->
  <div class="card card-border">
    <div class="card-body">
      <h3 class="card-title text-base">Shift history</h3>
      <p class="text-base-content/70 text-sm">
        Past and current cashier sessions. Expand a row to view opening and closing reconciliation
        details.
      </p>
      @if (sessionsLoading()) {
        <div class="flex justify-center py-8">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      } @else if (sessions().length === 0) {
        <div class="text-center py-8 text-base-content/70">
          <p>No shifts found</p>
        </div>
      } @else {
        <div class="overflow-x-auto mt-4 max-h-[70vh] overflow-y-auto">
          <table class="table table-zebra">
            <thead class="sticky top-0 z-10 bg-base-100">
              <tr>
                <th class="w-12" scope="col"></th>
                <th>Opened at</th>
                <th>Closed at</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              @for (session of sessions(); track session.id) {
                <tr>
                  <td class="align-middle">
                    <button
                      type="button"
                      class="btn btn-sm btn-square btn-outline btn-neutral min-w-8"
                      (click)="toggleExpand(session)"
                      [attr.aria-expanded]="isSessionExpanded(session)"
                      [attr.aria-label]="
                        isSessionExpanded(session) ? 'Collapse details' : 'Expand details'
                      "
                      [title]="isSessionExpanded(session) ? 'Collapse details' : 'Expand details'"
                    >
                      @if (isSessionExpanded(session)) {
                        <span aria-hidden="true">▼</span>
                      } @else {
                        <span aria-hidden="true">▶</span>
                      }
                    </button>
                  </td>
                  <td class="whitespace-nowrap">{{ formatDateTime(session.openedAt) }}</td>
                  <td class="whitespace-nowrap">
                    @if (session.closedAt) {
                      {{ formatDateTime(session.closedAt) }}
                    } @else {
                      –
                    }
                  </td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="session.status === 'open'"
                      [class.badge-ghost]="session.status === 'closed'"
                    >
                      {{ session.status }}
                    </span>
                  </td>
                </tr>
                @if (isSessionExpanded(session)) {
                  <tr class="bg-base-200/50">
                    <td colspan="4" class="p-0">
                      <div class="px-4 py-3 pl-12">
                        @if (loadingDetailsSessionId() === session.id) {
                          <div class="flex items-center gap-2 text-base-content/70">
                            <span class="loading loading-spinner loading-sm"></span>
                            Loading reconciliation details…
                          </div>
                        } @else {
                          @let details = getShiftDetails(session);
                          @if (details) {
                            @if (details.opening.length > 0 || details.closing.length > 0) {
                              <div class="space-y-4">
                                @if (details.opening.length > 0) {
                                  <div>
                                    <p class="text-sm font-medium text-base-content/80 mb-2">
                                      Opening reconciliation
                                    </p>
                                    <div class="overflow-x-auto">
                                      <table class="table table-sm table-zebra">
                                        <thead>
                                          <tr>
                                            <th>Account</th>
                                            <th>Code</th>
                                            <th>Expected</th>
                                            <th>Declared</th>
                                            <th>Variance</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          @for (d of details.opening; track d.accountId) {
                                            <tr
                                              [class.bg-warning/10]="
                                                d.varianceCents && d.varianceCents !== '0'
                                              "
                                            >
                                              <td>{{ d.accountName }}</td>
                                              <td class="font-mono text-sm">{{ d.accountCode }}</td>
                                              <td>{{ formatCents(d.expectedBalanceCents) }}</td>
                                              <td>{{ formatCents(d.declaredAmountCents) }}</td>
                                              <td>{{ formatCents(d.varianceCents) }}</td>
                                            </tr>
                                          }
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                }
                                @if (details.closing.length > 0) {
                                  <div>
                                    <p class="text-sm font-medium text-base-content/80 mb-2">
                                      Closing reconciliation
                                    </p>
                                    <div class="overflow-x-auto">
                                      <table class="table table-sm table-zebra">
                                        <thead>
                                          <tr>
                                            <th>Account</th>
                                            <th>Code</th>
                                            <th>Expected</th>
                                            <th>Declared</th>
                                            <th>Variance</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          @for (d of details.closing; track d.accountId) {
                                            <tr
                                              [class.bg-warning/10]="
                                                d.varianceCents && d.varianceCents !== '0'
                                              "
                                            >
                                              <td>{{ d.accountName }}</td>
                                              <td class="font-mono text-sm">{{ d.accountCode }}</td>
                                              <td>{{ formatCents(d.expectedBalanceCents) }}</td>
                                              <td>{{ formatCents(d.declaredAmountCents) }}</td>
                                              <td>{{ formatCents(d.varianceCents) }}</td>
                                            </tr>
                                          }
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                }
                              </div>
                            } @else {
                              <p class="text-base-content/70 text-sm">
                                No reconciliation data for this shift.
                              </p>
                            }
                          } @else {
                            <p class="text-base-content/70 text-sm">
                              No reconciliation data for this shift.
                            </p>
                          }
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>

        @if (sessionsTotalPages() > 1) {
          <div class="join flex justify-center mt-4">
            <button
              class="join-item btn btn-sm"
              [disabled]="sessionsPage() === 1"
              (click)="onSessionsPageChange(sessionsPage() - 1)"
            >
              «
            </button>
            @for (page of sessionsPageNumbers(); track page) {
              <button
                class="join-item btn btn-sm"
                [class.btn-active]="sessionsPage() === page"
                (click)="onSessionsPageChange(page)"
              >
                {{ page }}
              </button>
            }
            <button
              class="join-item btn btn-sm"
              [disabled]="sessionsPage() === sessionsTotalPages()"
              (click)="onSessionsPageChange(sessionsPage() + 1)"
            >
              »
            </button>
          </div>
        }
      }
    </div>
  </div>

  <p class="text-sm text-base-content/60">
    <a
      routerLink="/dashboard/accounting/ledger"
      [queryParams]="{ tab: 'reconciliation' }"
      class="link link-hover"
    >
      View reconciliation history in Accounting →
    </a>
  </p>
</div>
