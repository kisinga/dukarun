<div class="space-y-4 lg:space-y-6">
  <!-- Header (matches order detail pattern) -->
  <div class="no-print">
    <button type="button" (click)="goBack()" class="btn btn-ghost btn-sm mb-3">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Customers
    </button>
    <h1 class="text-xl sm:text-2xl font-bold text-base-content">Customer Statement</h1>
  </div>

  @if (error()) {
    <div role="alert" class="alert alert-error">
      <span class="flex-1">{{ error() }}</span>
    </div>
  }

  @if (isLoading() && !customer()) {
    <div class="flex justify-center py-12">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
  }

  @if (customer() && !isLoading()) {
    <!-- Statement content (printable) -->
    <div class="statement-content">
      <div class="card bg-base-100 shadow-sm border border-base-300/60">
        <div class="card-body p-3 sm:p-4">
          <h2 class="card-title text-lg">{{ customerName() }}</h2>
          @if (customer()?.emailAddress && hasEmail()) {
            <p class="text-sm text-base-content/70">{{ customer()!.emailAddress }}</p>
          }
          @if (customer()?.phoneNumber) {
            <p class="text-sm text-base-content/70">{{ customer()!.phoneNumber }}</p>
          }
          <p class="text-sm text-base-content/60 mt-2">Statement · {{ totalOrders() }} order(s)</p>
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm border border-base-300/60 mt-4">
        <div class="card-body p-0">
          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Order</th>
                  <th class="text-right">Order total</th>
                  <th>Payments</th>
                  <th class="text-right">Balance / Status</th>
                  <th class="w-0"></th>
                </tr>
              </thead>
              <tbody>
                @for (order of orders(); track order.id) {
                  <tr>
                    <td class="whitespace-nowrap align-top">
                      {{ formatDate(order.orderPlacedAt || order.createdAt) }}
                    </td>
                    <td class="align-top">
                      <a
                        [routerLink]="['/dashboard/orders', order.id]"
                        class="link link-hover font-mono font-medium"
                      >
                        {{ order.code }}
                      </a>
                    </td>
                    <td class="text-right font-medium align-top">
                      {{ currencyService.format(getOrderTotal(order), false) }}
                    </td>
                    <td class="align-top">
                      @if (getSettledPayments(order).length > 0) {
                        <div
                          class="min-w-[12rem] rounded border border-base-300/60 overflow-hidden"
                        >
                          <table class="table table-xs table-zebra">
                            <thead>
                              <tr>
                                <th class="py-1">Method</th>
                                <th class="text-right py-1">Amount</th>
                                <th class="text-base-content/70 py-1">Date</th>
                              </tr>
                            </thead>
                            <tbody>
                              @for (p of getSettledPayments(order); track p.id) {
                                <tr>
                                  <td class="py-1">{{ p.method }}</td>
                                  <td class="text-right py-1">
                                    {{ currencyService.format(p.amount ?? 0, false) }}
                                  </td>
                                  <td class="text-base-content/70 text-xs py-1">
                                    {{ formatDate(p.createdAt) }}
                                  </td>
                                </tr>
                              }
                            </tbody>
                            <tfoot>
                              <tr class="border-t border-base-300 font-semibold bg-base-200/50">
                                <td class="py-1">Total</td>
                                <td class="text-right py-1">
                                  {{ currencyService.format(getPaymentsTotal(order), false) }}
                                </td>
                                <td class="py-1"></td>
                              </tr>
                            </tfoot>
                          </table>
                        </div>
                      } @else {
                        <span class="text-base-content/50 text-sm">—</span>
                      }
                    </td>
                    <td class="text-right align-top">
                      @if (getOrderBalance(order) === 0) {
                        <span class="badge badge-sm badge-success">Paid</span>
                      } @else {
                        <span class="badge badge-sm badge-warning">
                          Balance {{ currencyService.format(getOrderBalance(order), false) }}
                        </span>
                      }
                    </td>
                    <td class="align-top">
                      <a
                        [routerLink]="['/dashboard/payments']"
                        [queryParams]="{ orderId: order.id }"
                        class="link link-hover text-sm"
                      >
                        View payments
                      </a>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (orders().length === 0) {
            <p class="p-4 text-base-content/60 text-center">No orders for this customer.</p>
          }
        </div>
      </div>

      @if (customer()?.outstandingAmount != null && customer()!.outstandingAmount !== 0) {
        <div class="mt-4 card bg-base-200/50 border border-base-300/60 shadow-sm">
          <div class="card-body py-3 px-4">
            <p class="font-semibold text-base-content">
              Outstanding balance:
              <span class="text-warning">{{
                currencyService.format(customer()!.outstandingAmount ?? 0, false)
              }}</span>
            </p>
          </div>
        </div>
      }
    </div>

    <!-- Actions (hidden when printing) -->
    <div class="no-print flex flex-wrap items-center gap-2 pt-4 mt-4 border-t border-base-300/50">
      <button type="button" class="btn btn-primary btn-sm" (click)="printStatement()">
        Download PDF
      </button>
      @if (hasEmail()) {
        <button
          type="button"
          class="btn btn-outline btn-sm"
          [disabled]="emailSending()"
          (click)="sendStatementEmail()"
        >
          @if (emailSending()) {
            <span class="loading loading-spinner loading-xs"></span>
          }
          Email statement
        </button>
      }
      @if (hasPhone()) {
        <button
          type="button"
          class="btn btn-outline btn-sm"
          [disabled]="smsSending()"
          (click)="sendMiniStatementSms()"
        >
          @if (smsSending()) {
            <span class="loading loading-spinner loading-xs"></span>
          }
          Send mini statement (SMS)
        </button>
      }
    </div>

    @if (toastMessage()) {
      <div
        role="alert"
        class="alert no-print mt-4"
        [class.alert-success]="toastMessage()?.type === 'success'"
        [class.alert-error]="toastMessage()?.type === 'error'"
      >
        <span class="flex-1">{{ toastMessage()!.text }}</span>
        <button type="button" class="btn btn-ghost btn-xs" (click)="dismissToast()">Dismiss</button>
      </div>
    }
  }
</div>
