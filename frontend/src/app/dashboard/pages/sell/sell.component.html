<!-- Toast Notification -->
@if (notificationMessage()) {
  <div class="toast toast-top toast-center z-50">
    <div
      class="alert shadow-lg anim-fade-in-down"
      [class.alert-success]="notificationType() === 'success'"
      [class.alert-warning]="notificationType() === 'warning'"
      [class.alert-error]="notificationType() === 'error'"
    >
      <span class="text-sm">{{ notificationMessage() }}</span>
    </div>
  </div>
}

<!-- Session required banner -->
@if (!cashierSessionService.hasActiveSession()) {
  <div class="alert alert-warning mx-4 md:mx-6 mt-3 md:mt-4 p-3 sm:p-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
      <path
        fill-rule="evenodd"
        d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
        clip-rule="evenodd"
      />
    </svg>
    <span>Open a session to sell. Go to the Dashboard and click "Open shift" first.</span>
    <a routerLink="/dashboard" class="btn btn-sm btn-ghost">Open shift</a>
  </div>
}

<!-- Main Content -->
<div class="container-app py-4 md:py-6 space-y-4 md:space-y-6 pb-20 md:pb-6">
  <!-- Search View -->
  <app-product-search-view
    [searchResults]="searchResults()"
    [isSearching]="isSearching()"
    [showCameraButton]="isManualSearchActive()"
    (searchTermChange)="handleSearchTermChange($event)"
    (productSelected)="handleProductSelected($event)"
    (variantSelected)="handleVariantSelectedFromSearch($event)"
    (cameraToggle)="handleClearSearch()"
  />

  <!-- Camera (conditional) -->
  @if (shouldShowCamera()) {
    <app-product-scanner
      #scanner
      [channelId]="channelId()"
      [autoStartOnMobile]="true"
      (scannerReady)="handleScannerReady(scanner)"
      (scanningStateChange)="handleScanningStateChange($event)"
      (productDetected)="handleProductDetected($event)"
    />
  }

  <!-- Recent Products List (always visible on desktop, conditional on mobile) -->
  @if (shouldShowCamera() || !isMobile()) {
    <div class="mt-4 md:mt-6">
      @if (isLoadingProducts()) {
        <div class="card bg-base-100 shadow-lg">
          <div class="card-body p-3 md:p-4">
            <div class="flex items-center justify-center py-4">
              <span class="loading loading-spinner loading-md"></span>
              <span class="ml-2 text-sm text-base-content/70">Loading products...</span>
            </div>
          </div>
        </div>
      } @else if (recentProducts().length > 0) {
        <div
          class="collapse collapse-arrow bg-base-100 border border-base-300 rounded-lg shadow-lg min-h-11"
        >
          <input
            type="checkbox"
            id="sell-quick-select-toggle"
            [checked]="quickSelectOpen()"
            (change)="onQuickSelectToggle($any($event.target).checked)"
            aria-label="Toggle Quick Select"
          />
          <label
            for="sell-quick-select-toggle"
            class="collapse-title font-semibold text-base md:text-lg tracking-tight min-h-11 flex items-center justify-between gap-2 py-3 cursor-pointer"
          >
            <span>Quick Select</span>
            <span class="badge badge-sm badge-primary badge-outline shrink-0">{{
              recentProducts().length
            }}</span>
          </label>
          <div class="collapse-content">
            <div class="space-y-3 max-h-[23vh] overflow-y-auto pb-1">
              @for (product of recentProducts(); track product.id) {
                <div class="border border-base-300 rounded-lg overflow-hidden bg-base-100">
                  <button
                    class="w-full flex items-center gap-3 p-3 bg-base-200 active:bg-base-300 hover:bg-base-300 transition-colors min-h-11 touch-manipulation"
                    (click)="handleQuickAddProduct(product)"
                  >
                    <!-- Product Image -->
                    @if (product.featuredAsset) {
                      <img
                        [src]="product.featuredAsset.preview"
                        [alt]="product.name"
                        class="w-10 h-10 rounded object-cover flex-shrink-0"
                      />
                    } @else {
                      <div
                        class="w-10 h-10 rounded bg-base-300 flex items-center justify-center flex-shrink-0"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-5 w-5 text-primary"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                          />
                        </svg>
                      </div>
                    }

                    <!-- Product Info -->
                    <div class="flex-1 text-left min-w-0">
                      <app-product-label
                        [productName]="product.name"
                        [facetValues]="product.facetValues ?? []"
                      />
                      @if (product.variants.length > 1) {
                        <div class="text-xs text-base-content/70">
                          {{ product.variants.length }} variants
                        </div>
                      }
                    </div>

                    <!-- Price (for single variant) or Add Icon -->
                    @if (product.variants.length === 1) {
                      <div class="text-sm font-semibold text-primary flex-shrink-0">
                        {{ formatPrice(product.variants[0].priceWithTax) }}
                      </div>
                    }
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 text-primary flex-shrink-0"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                  </button>
                  @if (product.variants.length > 1) {
                    <details
                      class="collapse collapse-arrow border-t border-base-300 bg-base-200/60"
                      [class.collapse-open]="product.variants.length <= 3"
                      [attr.open]="product.variants.length <= 3"
                    >
                      <summary
                        class="collapse-title min-h-0 py-1 pl-6 pr-2 text-xs text-base-content/70 cursor-pointer"
                      >
                        <span class="sr-only">Toggle variants</span>
                      </summary>
                      <div class="collapse-content pl-6 pr-2 pb-1.5 pt-0">
                        <app-variant-list [variants]="product.variants" />
                      </div>
                    </details>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Empty State (only when searching but no results) -->
  @if (isManualSearchActive() && searchResults().length === 0 && !isSearching()) {
    <div class="text-center py-12">
      <div class="text-5xl mb-2">üîç</div>
      <p class="font-semibold">No products found</p>
      <p class="text-sm text-base-content/70 mt-1">Try a different search term</p>
    </div>
  }

  <!-- Inline Cart (Always Visible) -->
  <app-cart
    [items]="cartItems()"
    [canOverridePrices]="canOverridePrices()"
    [displayMode]="'inline'"
    (quantityChange)="handleCartQuantityChange($event)"
    (priceChange)="handlePriceOverrideChange($event)"
    (removeItem)="handleCartItemRemove($event)"
    (clearCart)="handleClearCart()"
  />
</div>

<!-- Checkout FAB -->
@if (cartItems().length > 0) {
  <app-checkout-fab
    [total]="cartTotal()"
    [disabled]="!cashierSessionService.hasActiveSession()"
    [cartJustUpdated]="cartItemAdded()"
    (checkout)="handleProceedToCheckout()"
  />
}

<!-- Floating Camera Button (Mobile only, when searching) -->
@if (isManualSearchActive()) {
  <button
    class="btn btn-circle btn-primary btn-lg fixed bottom-20 right-4 z-40 md:hidden shadow-lg"
    (click)="handleClearSearch()"
    aria-label="Back to camera"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
      />
      <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  </button>
}

<!-- Product Confirmation Modal -->
<app-product-confirm-modal
  [isOpen]="showConfirmModal()"
  [product]="detectedProduct()"
  [canOverridePrices]="canOverridePrices()"
  (variantSelected)="handleVariantSelected($event)"
  (closeModal)="handleConfirmModalClose()"
/>

<!-- Clear Cart Confirmation Modal -->
@if (showClearCartConfirm()) {
  <div class="modal modal-open modal-bottom sm:modal-middle modal-backdrop-anim">
    <div class="modal-box modal-box-anim">
      <h3 class="font-bold text-lg text-error mb-4">Clear Cart</h3>
      <p class="py-4 text-base-content/80">
        Are you sure you want to clear all items from your cart? This action cannot be undone.
      </p>
      <div class="modal-action">
        <button class="btn btn-ghost" (click)="handleCancelClearCart()">Cancel</button>
        <button class="btn btn-error" (click)="handleConfirmClearCart()">Clear Cart</button>
      </div>
    </div>
  </div>
}

<!-- Checkout Modal -->
<app-checkout-modal
  [isOpen]="showCheckoutModal()"
  [checkoutType]="checkoutType()"
  [itemCount]="cartItemCount()"
  [total]="cartTotal()"
  [error]="checkoutError()"
  [isProcessing]="isProcessingCheckout()"
  [cashierFlowEnabled]="cashierFlowEnabled()"
  [triggerSuccess]="successTrigger()"
  [enablePrinter]="enablePrinter()"
  [selectedCustomer]="selectedCustomer()"
  [customerSearchResults]="customerSearchResults()"
  [isSearchingCustomers]="isSearchingCustomers()"
  [selectedCustomerForCash]="selectedCustomerForCash()"
  [customerSearchResultsForCash]="customerSearchResultsForCash()"
  [isSearchingCustomersForCash]="isSearchingCustomersForCash()"
  [selectedPaymentMethod]="selectedPaymentMethod()"
  (completeCashier)="handleCompleteCashier()"
  (completeCredit)="handleCompleteCredit()"
  (completeCreditAndPrint)="handleCompleteCreditAndPrint()"
  (completeCash)="handleCompleteCash()"
  (completeCashAndPrint)="handleCompleteCashAndPrint()"
  (customerSearch)="handleCustomerSearch($event)"
  (customerSelect)="handleCustomerSelect($event)"
  (customerSearchForCash)="handleCustomerSearchForCash($event)"
  (customerSelectForCash)="handleCustomerSelectForCash($event)"
  (customerCreate)="handleCustomerCreate($event)"
  (customerCreateForCash)="handleCustomerCreateForCash($event)"
  (paymentMethodSelect)="handlePaymentMethodSelect($event)"
  (selectCredit)="handleCheckoutCredit()"
  (selectCash)="handleCheckoutCash()"
  (selectCashier)="handleCheckoutCashier()"
  (closeModal)="handleCheckoutModalClose()"
/>
