<!-- Product Edit Form -->

<!-- Header -->
<div class="sticky top-0 z-30 bg-base-100/95 backdrop-blur-sm border-b">
  <div class="container-app py-2">
    <div class="flex items-center justify-between gap-2">
      <h1 class="text-lg font-bold">Edit product</h1>
      <button
        type="button"
        (click)="cancel()"
        class="btn btn-sm btn-circle bg-base-200 hover:bg-base-300 text-base-content border-0"
      >
        ‚úï
      </button>
    </div>

    <!-- Steps -->
    <ul class="steps steps-horizontal w-full text-[11px] mt-2">
      <li class="step" [class.step-primary]="currentStage() === 1" (click)="goToStage1()">
        Details
      </li>
      <li class="step" [class.step-primary]="currentStage() === 2" (click)="goToStage2()">
        Pricing & stock
      </li>
    </ul>
  </div>
</div>

<!-- Main Content -->
<div class="container-app py-3 pb-32 max-w-lg mx-auto">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-12">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm text-base-content/60 mt-4">Loading product...</p>
        </div>
      </div>
    </div>
  }

  <!-- Alerts -->
  @if (submitSuccess()) {
    <div role="alert" class="alert alert-success mb-3">
      <span>‚úì Product updated!</span>
    </div>
  }
  @if (submitError()) {
    <div role="alert" class="alert alert-error mb-3">
      <span>{{ submitError() }}</span>
    </div>
  }

  <!-- Form -->
  @if (!isLoading()) {
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="space-y-3">
      <!-- Stage 1: Basics & photos -->
      @if (currentStage() === 1) {
        <app-product-name-input [nameControl]="nameControl" />

        <div class="card bg-base-100 shadow">
          <div class="card-body p-3">
            <div class="flex items-center justify-between mb-2">
              <div>
                <h3 class="font-bold text-sm">Product Photos</h3>
                <p class="text-xs opacity-70">AI recognition images</p>
              </div>
              @if (!showPhotoEditor()) {
                <button
                  type="button"
                  (click)="showPhotoEditUnlock()"
                  class="btn btn-xs btn-warning gap-1"
                >
                  <span>üì∏</span>
                  <span>Edit Photos</span>
                </button>
              }
            </div>

            <!-- Photo Display -->
            @if (productAssets().length === 0) {
              <div class="text-center py-6 bg-base-200 rounded">
                <div class="text-2xl mb-2">üì∑</div>
                <p class="text-sm opacity-70">No photos yet</p>
                <p class="text-xs opacity-50">Add photos for better AI recognition</p>
              </div>
            } @else {
              <div class="grid grid-cols-4 gap-2">
                @for (asset of productAssets(); track asset.id) {
                  <div class="aspect-square relative">
                    <img
                      [src]="asset.preview"
                      [alt]="asset.name"
                      class="w-full h-full object-cover rounded border"
                    />
                    @if ($index === 0) {
                      <div class="badge badge-xs badge-primary absolute bottom-1 left-1">
                        ‚≠ê Main
                      </div>
                    }
                  </div>
                }
              </div>
            }

            <!-- Photo Editor -->
            @if (showPhotoEditor()) {
              <div class="mt-4 p-3 bg-warning/10 rounded border border-warning/20">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <span class="text-warning">‚ö†Ô∏è</span>
                    <span class="text-sm font-semibold">Photo Editor Active</span>
                  </div>
                  <button type="button" (click)="closePhotoEditor()" class="btn btn-xs btn-ghost">
                    ‚úï Close
                  </button>
                </div>

                <app-photo-editor
                  #photoEditor
                  [existingAssets]="productAssets()"
                  (photosChanged)="onPhotosChanged($event)"
                />
              </div>
            }
          </div>
        </div>
      }

      <!-- Stage 2: SKUs & pricing -->
      @if (currentStage() === 2) {
        <div class="card bg-base-100 shadow">
          <div class="card-body p-3">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-bold text-sm">SKUs (Sizes/Tiers)</h3>
              <button type="button" (click)="addSku()" class="btn btn-xs btn-primary">
                + Add SKU
              </button>
            </div>

            <div class="bg-info/10 p-2 rounded text-xs mb-3">
              <strong>Note:</strong> Stock values are read-only. Use the Inventory module to adjust
              stock levels.
            </div>

            <!-- SKU List -->
            <div formArrayName="skus" class="space-y-3">
              @for (sku of skus.controls; track $index) {
                <div [formGroupName]="$index" class="p-3 bg-base-200 rounded">
                  <div class="flex items-start justify-between gap-2 mb-2">
                    <span class="text-xs font-semibold opacity-70">SKU #{{ $index + 1 }}</span>
                    @if (skus.length > 1) {
                      <button
                        type="button"
                        (click)="removeSku($index)"
                        class="btn btn-xs btn-ghost btn-circle text-error"
                      >
                        ‚úï
                      </button>
                    }
                  </div>

                  <div class="space-y-2">
                    <!-- SKU Name -->
                    <div>
                      <label class="text-xs opacity-70 mb-1 block">Name</label>
                      <input
                        type="text"
                        formControlName="name"
                        placeholder="e.g., 1kg"
                        class="input input-sm input-bordered w-full"
                        [class.input-error]="skuFieldHasError($index, 'name')"
                      />
                      @if (skuFieldHasError($index, 'name')) {
                        <p class="text-error text-xs mt-0.5">
                          {{ getSkuFieldError($index, 'name') }}
                        </p>
                      }
                    </div>

                    <!-- SKU Code (Read-only) -->
                    <div>
                      <label class="text-xs opacity-70 mb-1 block">SKU Code</label>
                      <div class="px-3 py-2 bg-base-300 rounded text-xs font-mono opacity-70">
                        {{ sku.get('sku')?.value }}
                      </div>
                    </div>

                    <!-- Price & Stock -->
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <label class="text-xs opacity-70 mb-1 block">Price (inc tax)</label>
                        <input
                          type="number"
                          formControlName="price"
                          placeholder="0.00"
                          step="0.01"
                          min="0.01"
                          class="input input-sm input-bordered w-full"
                          [class.input-error]="skuFieldHasError($index, 'price')"
                        />
                        @if (skuFieldHasError($index, 'price')) {
                          <p class="text-error text-xs mt-0.5">
                            {{ getSkuFieldError($index, 'price') }}
                          </p>
                        }
                      </div>

                      <div>
                        <label class="text-xs opacity-70 mb-1 block">Stock (read-only)</label>
                        <input
                          type="number"
                          formControlName="stockOnHand"
                          readonly
                          class="input input-sm input-bordered input-disabled w-full"
                        />
                      </div>
                    </div>

                    <!-- Wholesale Price -->
                    <div>
                      <label class="text-xs opacity-70 mb-1 block"
                        >Wholesale Price (Optional)</label
                      >
                      <input
                        type="number"
                        formControlName="wholesalePrice"
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                        class="input input-sm input-bordered w-full"
                      />
                      <p class="text-xs opacity-60 mt-1">Discount limit guardrail</p>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <app-validation-issues-panel [issues]="validationIssues()" />
      }

      <!-- Actions -->
      <div class="card bg-base-100 shadow sticky bottom-2">
        <div class="card-body p-3">
          <div class="flex gap-2">
            <button
              type="button"
              (click)="cancel()"
              class="btn btn-ghost flex-1"
              [disabled]="isSubmitting()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary flex-1" [disabled]="!canSubmit()">
              @if (isSubmitting()) {
                <span class="loading loading-spinner loading-sm"></span>
                Saving...
              } @else {
                üíæ Save Changes
              }
            </button>
          </div>
        </div>
      </div>
    </form>
  }

  <!-- Photo Edit Unlock Modal -->
  @if (showUnlockModal()) {
    <app-photo-edit-unlock-modal
      (confirmed)="onPhotoEditUnlocked()"
      (cancelled)="onPhotoEditCancelled()"
    />
  }
</div>
