<div class="space-y-4 anim-stagger">
  <!-- Create manual reconciliation -->
  @if (tableAccounts().length > 0) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <h2 class="card-title">Create manual reconciliation</h2>
        <p class="text-base-content/70">
          Unlock each account you want to reconcile, enter the declared amount, then submit. Only
          unlocked accounts are updated in the ledger. This creates a snapshot and posts variance
          for those accounts.
        </p>
        <div role="alert" class="alert alert-warning mt-2">
          <span
            >If a transaction is posted before you apply, the snapshot may be stale and applying can
            cause inconsistency. Submit in a quiet moment.</span
          >
        </div>
        @if (manualError(); as err) {
          <div role="alert" class="alert alert-error mt-2">
            <span>{{ err }}</span>
            <button type="button" class="btn btn-sm" (click)="manualError.set(null)">
              Dismiss
            </button>
          </div>
        }
        <div class="mt-4">
          <span class="label">Snapshot as of</span>
          <p class="text-base font-medium mt-1" aria-readonly="true">{{ reconciliationDate() }}</p>
          <p class="label-text-alt text-base-content/60">Today only; no backdating.</p>
        </div>
        <label class="form-control mt-2 w-full max-w-md">
          <span class="label">Notes (optional)</span>
          <input
            type="text"
            class="input input-bordered w-full"
            placeholder="e.g. Month-end snapshot"
            [value]="manualNotes()"
            (input)="manualNotes.set($any($event.target).value)"
          />
        </label>
        <p class="label mt-4">Declared amount per account (Ksh)</p>
        <p class="label-text-alt text-base-content/60 mb-2">
          Click Edit to unlock an account, then enter the declared amount. Only unlocked accounts
          are included when you submit and will be updated in the ledger.
        </p>
        @if (manualBalancesLoading()) {
          <p class="text-sm text-base-content/60 py-2">Loading current balances…</p>
        }
        <div class="overflow-x-auto max-h-60 overflow-y-auto border border-base-300 rounded-lg">
          <table class="table table-sm">
            <thead class="sticky top-0 z-10 bg-base-100">
              <tr>
                <th class="w-20">Edit</th>
                <th>Account</th>
                <th>Code</th>
                <th>Type</th>
                <th>Current (Ksh)</th>
                <th>Declared (Ksh)</th>
                <th>Variance (Ksh)</th>
              </tr>
            </thead>
            <tbody>
              @for (acc of tableAccounts(); track acc.id) {
                <tr>
                  <td>
                    @if (acc.isSystemAccount) {
                      <span class="text-base-content/40 text-sm">—</span>
                    } @else {
                      @if (isAccountUnlocked(acc.id)) {
                        <span class="badge badge-success badge-sm">Editing</span>
                      } @else {
                        <button
                          type="button"
                          class="btn btn-xs btn-outline btn-primary"
                          (click)="unlockAccountForEdit(acc.id)"
                        >
                          Edit
                        </button>
                      }
                    }
                  </td>
                  <td>{{ acc.name }}</td>
                  <td class="font-mono text-sm">{{ acc.code }}</td>
                  <td>
                    <span class="badge badge-ghost badge-sm">{{ accountTypeLabel(acc.type) }}</span>
                    @if (acc.isSystemAccount) {
                      <span class="badge badge-warning badge-soft badge-sm ml-1">System</span>
                    }
                  </td>
                  <td class="tabular-nums">
                    {{ formatShillings(getCurrentBalanceShillings(acc.id)) }}
                  </td>
                  <td>
                    @if (acc.isSystemAccount) {
                      <span class="text-base-content/50 text-sm">—</span>
                    } @else if (isAccountUnlocked(acc.id)) {
                      <input
                        type="number"
                        class="input input-bordered input-sm w-28"
                        min="0"
                        step="0.01"
                        [value]="getManualDeclared(acc.id)"
                        (input)="setManualDeclared(acc.id, +$any($event.target).value || 0)"
                      />
                    } @else {
                      <span class="text-base-content/50 text-sm">—</span>
                    }
                  </td>
                  <td
                    class="tabular-nums"
                    [class.text-warning]="getVarianceShillings(acc.id) !== 0"
                  >
                    {{ formatShillings(getVarianceShillings(acc.id)) }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        <div class="card-actions mt-4">
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="manualSubmitting() || !hasEditedAccounts()"
            (click)="submitManualReconciliation()"
          >
            @if (manualSubmitting()) {
              <span class="loading loading-spinner loading-sm"></span>
            }
            Create reconciliation
          </button>
        </div>
      </div>
    </div>
  }

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title">Reconciliation history</h2>
      <p class="text-base-content/70">
        All reconciliation events: opening shift, closing shift, and manual reconciliations. Each
        row shows expected vs actual balances and variance.
      </p>

      @if (context().isLoading) {
        <div class="flex justify-center py-8">
          <span class="loading loading-spinner loading-lg"></span>
        </div>
      } @else if (context().reconciliations.length === 0) {
        <div class="text-center py-8 text-base-content/70">
          <p>No reconciliations found</p>
        </div>
      } @else {
        <div class="overflow-x-auto mt-4 max-h-[70vh] overflow-y-auto">
          <table class="table table-zebra">
            <thead class="sticky top-0 z-10 bg-base-100">
              <tr>
                <th class="w-12" scope="col"></th>
                <th>Date range</th>
                <th>Scope</th>
                <th>Scope ref</th>
                <th>Expected</th>
                <th>Actual</th>
                <th>Variance</th>
                <th>Status</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              @for (r of context().reconciliations; track r.id) {
                <tr [class.bg-warning/10]="hasVariance(r)">
                  <td class="align-middle">
                    <button
                      type="button"
                      class="btn btn-sm btn-square btn-outline btn-neutral min-w-8"
                      (click)="toggleExpand(r)"
                      [attr.aria-expanded]="isExpanded(r)"
                      [attr.aria-label]="isExpanded(r) ? 'Collapse details' : 'Expand details'"
                      [title]="isExpanded(r) ? 'Collapse details' : 'Expand details'"
                    >
                      @if (isExpanded(r)) {
                        <span aria-hidden="true">▼</span>
                      } @else {
                        <span aria-hidden="true">▶</span>
                      }
                    </button>
                  </td>
                  <td class="whitespace-nowrap">
                    {{ context().formatDate(r.rangeStart) }} –
                    {{ context().formatDate(r.rangeEnd) }}
                  </td>
                  <td>
                    <span class="badge badge-outline">{{ r.scope }}</span>
                  </td>
                  <td class="font-mono text-sm">{{ r.scopeRefId }}</td>
                  <td>{{ context().formatCurrency(r.expectedBalance ?? '0') }}</td>
                  <td>{{ context().formatCurrency(r.actualBalance ?? '0') }}</td>
                  <td>
                    @if (hasVariance(r)) {
                      <span class="font-semibold text-warning">{{
                        context().formatCurrency(r.varianceAmount)
                      }}</span>
                    } @else {
                      {{ context().formatCurrency(r.varianceAmount) }}
                    }
                  </td>
                  <td>
                    <span
                      class="badge"
                      [class.badge-success]="r.status === 'verified'"
                      [class.badge-warning]="r.status !== 'verified'"
                    >
                      {{ r.status }}
                    </span>
                  </td>
                  <td class="max-w-32 truncate" [title]="r.notes ?? ''">{{ r.notes ?? '–' }}</td>
                </tr>
                @if (isExpanded(r)) {
                  <tr class="bg-base-200/50">
                    <td colspan="9" class="p-0">
                      <div class="px-4 py-3 pl-12">
                        @if (loadingDetailsId() === r.id) {
                          <div class="flex items-center gap-2 text-base-content/70">
                            <span class="loading loading-spinner loading-sm"></span>
                            Loading accounts…
                          </div>
                        } @else {
                          @let details = getDetails(r);
                          @if (details.length === 0) {
                            <p class="text-base-content/70 text-sm">
                              No per-account data for this reconciliation.
                            </p>
                          } @else {
                            <table class="table table-sm table-zebra">
                              <thead>
                                <tr>
                                  <th>Account</th>
                                  <th>Code</th>
                                  <th>Expected</th>
                                  <th>Declared</th>
                                  <th>Variance</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (d of details; track d.accountId) {
                                  <tr
                                    [class.bg-warning/10]="
                                      d.varianceCents && d.varianceCents !== '0'
                                    "
                                  >
                                    <td>{{ d.accountName }}</td>
                                    <td class="font-mono text-sm">{{ d.accountCode }}</td>
                                    <td>
                                      {{
                                        d.expectedBalanceCents != null
                                          ? context().formatCurrency(d.expectedBalanceCents)
                                          : '–'
                                      }}
                                    </td>
                                    <td>
                                      {{
                                        d.declaredAmountCents != null
                                          ? context().formatCurrency(d.declaredAmountCents)
                                          : '–'
                                      }}
                                    </td>
                                    <td>
                                      @if (d.varianceCents && d.varianceCents !== '0') {
                                        <span class="font-semibold text-warning">{{
                                          context().formatCurrency(d.varianceCents)
                                        }}</span>
                                      } @else {
                                        {{
                                          d.varianceCents != null
                                            ? context().formatCurrency(d.varianceCents)
                                            : '–'
                                        }}
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          }
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>

        @if (totalPages() > 1) {
          <div class="join flex justify-center mt-4">
            <button
              class="join-item btn btn-sm"
              [disabled]="context().currentPage === 1"
              (click)="onPageChange(context().currentPage - 1)"
            >
              «
            </button>
            @for (page of pageNumbers(); track page) {
              <button
                class="join-item btn btn-sm"
                [class.btn-active]="context().currentPage === page"
                (click)="onPageChange(page)"
              >
                {{ page }}
              </button>
            }
            <button
              class="join-item btn btn-sm"
              [disabled]="context().currentPage === totalPages()"
              (click)="onPageChange(context().currentPage + 1)"
            >
              »
            </button>
          </div>
        }
      }
    </div>
  </div>
</div>
