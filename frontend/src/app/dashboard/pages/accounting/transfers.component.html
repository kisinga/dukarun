<div class="fixed bottom-24 right-4 z-40 lg:hidden">
  <button
    type="button"
    class="btn btn-lg btn-circle btn-primary shadow-xl"
    (click)="openCreateTransfer()"
    [disabled]="!canCreate()"
    [attr.aria-label]="canCreate() ? 'Create transfer' : 'Create transfer (permission required)'"
    [title]="canCreate() ? 'Create transfer' : 'You need permission to create transfers'"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
      />
    </svg>
  </button>
</div>

<div class="space-y-4 sm:space-y-5 lg:space-y-6 anim-stagger">
  <app-page-header title="Inter-account transfers" subtitle="Move funds between accounts">
    <div actions class="flex items-center gap-1">
      <button
        class="btn btn-ghost btn-sm btn-square shrink-0 touch-manipulation"
        (click)="refresh()"
        [class.loading]="isLoading()"
        [disabled]="isLoading()"
        title="Refresh"
      >
        @if (!isLoading()) {
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
        }
      </button>
      <button
        type="button"
        class="btn btn-primary btn-sm gap-1.5 flex touch-manipulation"
        (click)="openCreateTransfer()"
        [disabled]="!canCreate()"
        [title]="canCreate() ? 'Create a new transfer' : 'You need permission to create transfers'"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Create transfer
      </button>
    </div>
  </app-page-header>

  @if (error()) {
    <div role="alert" class="alert alert-error">
      <span class="flex-1">{{ error() }}</span>
      <button (click)="refresh()" class="btn btn-sm">Retry</button>
    </div>
  }

  @if (isLoading()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm text-base-content/60 mt-4">Loading transfers...</p>
        </div>
      </div>
    </div>
  } @else if (entries().length === 0 && !error()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="text-center py-12 lg:py-16 px-4">
          <div
            class="w-16 h-16 lg:w-20 lg:h-20 mx-auto mb-4 rounded-full bg-base-200 flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 lg:h-10 lg:w-10 text-base-content/30"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
              />
            </svg>
          </div>
          <h3 class="text-lg font-semibold">No transfers yet</h3>
          <p class="text-sm text-base-content/60 mt-2 max-w-md mx-auto">
            Move funds between accounts (e.g. Cash to M-Pesa). Create a transfer when you need to
            record till moves or bank transfers.
          </p>
          <button
            (click)="openCreateTransfer()"
            class="btn btn-primary mt-6 gap-2"
            [disabled]="!canCreate()"
            [title]="canCreate() ? null : 'You need permission to create transfers'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              />
            </svg>
            Create transfer
          </button>
          @if (!canCreate()) {
            <p class="text-sm text-base-content/50 mt-4">
              You need permission to create transfers.
            </p>
          }
        </div>
      </div>
    </div>
  } @else if (entries().length > 0) {
    <div class="card bg-base-100 shadow">
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Date</th>
                <th>From → To</th>
                <th>Memo</th>
                <th class="text-right">Amount</th>
              </tr>
            </thead>
            <tbody class="anim-stagger-rows">
              @for (entry of entries(); track entry.id) {
                <tr
                  role="button"
                  tabindex="0"
                  class="cursor-pointer hover:bg-base-200 active:bg-base-300"
                  (click)="viewEntry(entry)"
                  (keydown.enter)="viewEntry(entry)"
                  (keydown.space)="viewEntry(entry)"
                >
                  <td>{{ formatDate(entry.entryDate) }}</td>
                  <td>
                    <span class="font-medium">{{ getTransferFromTo(entry).from }}</span>
                    <span class="text-base-content/50 mx-1">→</span>
                    <span class="font-medium">{{ getTransferFromTo(entry).to }}</span>
                  </td>
                  <td>{{ entry.memo || '-' }}</td>
                  <td class="text-right font-semibold tabular-nums">
                    {{ formatCurrency(getEntryAmount(entry)) }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        <p class="text-sm text-base-content/50 px-4 py-2 border-t border-base-300">
          Click a row to view details.
        </p>
      </div>
    </div>
  }
</div>

<app-create-transfer-modal
  (transferred)="onTransferCreated()"
  (cancelled)="onTransferCancelled()"
></app-create-transfer-modal>

<app-transaction-detail-modal
  [entry]="selectedEntry()"
  (closed)="onDetailClosed()"
></app-transaction-detail-modal>
