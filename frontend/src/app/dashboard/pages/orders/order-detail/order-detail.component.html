@if (modalMode()) {
  <!-- Modal Wrapper -->
  <dialog #modalDialog [id]="modalId()" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto p-4 sm:p-6">
      <!-- Order Content -->
      <ng-container [ngTemplateOutlet]="orderContent"></ng-container>
      <div class="modal-action mt-4 sm:mt-6">
        <button class="btn btn-primary w-full sm:w-auto touch-manipulation" (click)="close()">
          Close
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button (click)="close()">close</button>
    </form>
  </dialog>
}

<div class="space-y-3 sm:space-y-4 lg:space-y-6" [class.print-mode]="isPrintMode()">
  <!-- Header (hidden in print mode and modal mode) -->
  @if (showHeader() && !modalMode()) {
    <div class="no-print">
      <!-- Back Button -->
      <button (click)="goBack()" class="btn btn-ghost btn-sm mb-3">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Orders
      </button>
    </div>
  }

  <!-- Error Alert -->
  @if (error()) {
    <div role="alert" class="alert alert-error shadow-lg" [class.no-print]="!modalMode()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 sm:h-6 sm:w-6 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="flex-1 text-sm sm:text-base">{{ error() }}</span>
      <button (click)="clearError()" class="btn btn-sm touch-manipulation">Dismiss</button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body p-6 sm:p-8">
        <div class="flex flex-col items-center justify-center py-12 sm:py-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm sm:text-base text-base-content/60 mt-4">Loading order...</p>
        </div>
      </div>
    </div>
  }

  <!-- Order Details -->
  @if (order()) {
    <ng-container [ngTemplateOutlet]="orderDetailsContent"></ng-container>
  }
</div>

<!-- Order Details Content Template (shared) -->
<ng-template #orderDetailsContent>
  <div class="space-y-3 sm:space-y-4 lg:space-y-6">
    <!-- Order Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300/60">
      <div class="card-body p-3 sm:p-4">
        <app-order-detail-header
          [orderCode]="order()!.code"
          [orderState]="order()!.state"
          [orderDate]="order()!.orderPlacedAt || order()!.createdAt"
        />
      </div>
    </div>

    <!-- Mobile: Expansion Panels -->
    <div class="lg:hidden space-y-2">
      <!-- Customer & Billing Address Expansion Panel -->
      <div
        class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
      >
        <input type="checkbox" />
        <div class="collapse-title text-sm font-semibold px-3 py-2.5">
          <div class="flex items-center justify-between gap-2">
            <span class="truncate flex-1">{{ customerName() }}</span>
            <span class="text-xs font-normal text-base-content/50 shrink-0">Customer</span>
          </div>
        </div>
        <div class="collapse-content px-3 pb-3">
          <div class="space-y-3 pt-2">
            <!-- Customer Info -->
            <app-order-customer-info [customer]="order()!.customer" />

            <!-- Billing Address -->
            <div class="pt-3 border-t border-base-300/50">
              <app-order-address
                [address]="order()!.billingAddress"
                [label]="'Billing Address'"
                [fallbackName]="customerName()"
              />
            </div>

            <!-- Shipping Address (if exists) -->
            @if (hasShipping() && order()!.shippingAddress) {
              <div class="pt-3 border-t border-base-300/50">
                <app-order-address
                  [address]="order()!.shippingAddress"
                  [label]="'Shipping Address'"
                  [fallbackName]="customerName()"
                />
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Payment Information Expansion Panel -->
      <div
        class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
      >
        <input type="checkbox" />
        <div class="collapse-title text-sm font-semibold px-3 py-2.5">Payment Information</div>
        <div class="collapse-content px-3 pb-3">
          <app-order-payment-info [payments]="order()!.payments" />
          <a
            [routerLink]="['/dashboard/payments']"
            [queryParams]="{ orderId: order()!.id }"
            class="link link-hover text-sm mt-2 inline-block"
            >View in payments</a
          >
          @if (showPayOrderButton()) {
            <div class="divider my-3"></div>
            <div class="space-y-2">
              @if (paymentError()) {
                <div class="alert alert-error alert-sm">
                  <span>{{ paymentError() }}</span>
                  <button class="btn btn-ghost btn-xs" (click)="paymentError.set(null)">âœ•</button>
                </div>
              }
              @if (paymentSuccess()) {
                <div class="alert alert-success alert-sm">
                  <span>{{ paymentSuccess() }}</span>
                </div>
              }
              <button
                class="btn btn-primary btn-sm w-full"
                [disabled]="isProcessingPayment()"
                (click)="handlePayOrder()"
              >
                @if (isProcessingPayment()) {
                  <span class="loading loading-spinner loading-xs"></span>
                  Processing...
                } @else {
                  ðŸ’³ Pay Order
                  @if (outstandingAmount() > 0) {
                    ({{ currencyService.format(outstandingAmount()) }})
                  }
                }
              </button>
            </div>
          }
        </div>
      </div>

      <!-- Fulfillment Information Expansion Panel -->
      @if (order()!.fulfillments && order()!.fulfillments.length > 0) {
        <div
          class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
        >
          <input type="checkbox" />
          <div class="collapse-title text-sm font-semibold px-3 py-2.5">Fulfillment</div>
          <div class="collapse-content px-3 pb-3">
            <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
          </div>
        </div>
      }
    </div>

    <!-- Desktop: Side-by-side Layout -->
    <div class="hidden lg:grid lg:grid-cols-3 gap-4">
      <!-- Left Column: Customer & Addresses -->
      <div class="space-y-4">
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-3 sm:p-4">
            <app-order-customer-info [customer]="order()!.customer" />
            <div class="divider my-3"></div>
            <app-order-address
              [address]="order()!.billingAddress"
              [label]="'Billing Address'"
              [fallbackName]="customerName()"
            />
            @if (hasShipping() && order()!.shippingAddress) {
              <div class="divider my-3"></div>
              <app-order-address
                [address]="order()!.shippingAddress"
                [label]="'Shipping Address'"
                [fallbackName]="customerName()"
              />
            }
          </div>
        </div>

        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-3 sm:p-4">
            <app-order-payment-info [payments]="order()!.payments" />
            <a
              [routerLink]="['/dashboard/payments']"
              [queryParams]="{ orderId: order()!.id }"
              class="link link-hover text-sm mt-2 inline-block"
              >View in payments</a
            >
            @if (showPayOrderButton()) {
              <div class="divider my-3"></div>
              <div class="space-y-2">
                @if (paymentError()) {
                  <div class="alert alert-error alert-sm">
                    <span>{{ paymentError() }}</span>
                    <button class="btn btn-ghost btn-xs" (click)="paymentError.set(null)">âœ•</button>
                  </div>
                }
                @if (paymentSuccess()) {
                  <div class="alert alert-success alert-sm">
                    <span>{{ paymentSuccess() }}</span>
                  </div>
                }
                <button
                  class="btn btn-primary btn-sm w-full"
                  [disabled]="isProcessingPayment()"
                  (click)="handlePayOrder()"
                >
                  @if (isProcessingPayment()) {
                    <span class="loading loading-spinner loading-xs"></span>
                    Processing...
                  } @else {
                    ðŸ’³ Pay Order
                    @if (outstandingAmount() > 0) {
                      ({{ currencyService.format(outstandingAmount()) }})
                    }
                  }
                </button>
              </div>
            }
          </div>
        </div>

        @if (order()!.fulfillments && order()!.fulfillments.length > 0) {
          <div class="card bg-base-100 shadow-sm border border-base-300/60">
            <div class="card-body p-3 sm:p-4">
              <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
            </div>
          </div>
        }
      </div>

      <!-- Right Column: Items & Totals (2 columns) -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Order Items - Prominent -->
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-3 sm:p-4">
            <app-order-items-table [lines]="order()!.lines" />
          </div>
        </div>

        <!-- Totals -->
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-3 sm:p-4">
            <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile: Items & Totals (Full Width) -->
    <div class="lg:hidden space-y-3">
      <!-- Order Items - Prominent -->
      <div class="card bg-base-100 shadow-sm border border-base-300/60">
        <div class="card-body p-3">
          <app-order-items-table [lines]="order()!.lines" />
        </div>
      </div>

      <!-- Totals -->
      <div class="card bg-base-100 shadow-sm border border-base-300/60">
        <div class="card-body p-3">
          <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />
        </div>
      </div>
    </div>

    <!-- Void order (hidden in modal and print mode) -->
    @if (!modalMode() && canVoid()) {
      <div class="no-print mt-4 sm:mt-6 pt-4 border-t border-base-300/50">
        <button
          type="button"
          class="btn btn-outline btn-error btn-sm"
          [disabled]="isVoiding()"
          (click)="handleVoidOrder()"
        >
          @if (isVoiding()) {
            <span class="loading loading-spinner loading-xs"></span>
            Voiding...
          } @else {
            Void order
          }
        </button>
      </div>
    }

    <!-- Print Controls (at bottom, hidden in modal and print mode) -->
    @if (showPrintControls() && !modalMode() && canPrint()) {
      <div class="no-print mt-4 sm:mt-6 pt-4 border-t border-base-300/50">
        <app-print-controls [order]="order()" />
      </div>
    }

    <!-- Draft order: Edit, Complete to Sale (hidden in modal) -->
    @if (!modalMode() && isDraftOrder()) {
      <div class="no-print mt-4 sm:mt-6 pt-4 border-t border-base-300/50 space-y-4">
        <div class="flex flex-wrap gap-2">
          <a
            [routerLink]="['/dashboard/orders/edit', order()!.id]"
            class="btn btn-outline btn-sm gap-1.5"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
            Edit order
          </a>
        </div>
        <div class="card bg-base-200/50 border border-base-300">
          <div class="card-body p-4">
            <h3 class="font-semibold text-base">Complete to Sale</h3>
            <p class="text-sm text-base-content/70 mt-1">
              Add payment to convert this proforma into a completed sale.
            </p>
            @if (completeDraftError()) {
              <div class="alert alert-error mt-2 text-sm">
                <span>{{ completeDraftError() }}</span>
                <button class="btn btn-ghost btn-xs" (click)="completeDraftError.set(null)">
                  âœ•
                </button>
              </div>
            }
            @if (paymentSuccess()) {
              <div class="alert alert-success mt-2 text-sm">
                <span>{{ paymentSuccess() }}</span>
              </div>
            }
            <div class="flex flex-col sm:flex-row gap-3 mt-3">
              <select
                class="select select-bordered select-sm sm:flex-1"
                [value]="selectedCompletePaymentCode() ?? ''"
                (change)="selectedCompletePaymentCode.set($any($event.target).value || null)"
              >
                <option value="">Select payment method</option>
                @for (method of paymentMethods(); track method.code) {
                  <option [value]="method.code">{{ method.name }}</option>
                }
              </select>
              <button
                class="btn btn-primary btn-sm sm:flex-none"
                [disabled]="!selectedCompletePaymentCode() || isCompletingDraft()"
                (click)="handleCompleteDraftToSale()"
              >
                @if (isCompletingDraft()) {
                  <span class="loading loading-spinner loading-xs"></span>
                  Completing...
                } @else {
                  Complete to Sale
                }
              </button>
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</ng-template>

<!-- Order Content Template (for modal mode) -->
<ng-template #orderContent>
  <!-- Error Alert (for modal mode) -->
  @if (error()) {
    <div role="alert" class="alert alert-error mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 sm:h-6 sm:w-6 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="flex-1 text-sm sm:text-base">{{ error() }}</span>
      <button (click)="clearError()" class="btn btn-sm touch-manipulation">Dismiss</button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body p-6 sm:p-8">
        <div class="flex flex-col items-center justify-center py-12 sm:py-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm sm:text-base text-base-content/60 mt-4">Loading order...</p>
        </div>
      </div>
    </div>
  }

  <!-- Order Details (uses shared template) -->
  @if (order()) {
    <ng-container [ngTemplateOutlet]="orderDetailsContent"></ng-container>
  }
</ng-template>
