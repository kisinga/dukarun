@if (modalMode()) {
  <!-- Modal Wrapper -->
  <dialog #modalDialog [id]="modalId()" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg">Order Details</h3>
        <button class="btn btn-ghost btn-sm btn-circle" (click)="close()" aria-label="Close">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <!-- Order Content -->
      <ng-container [ngTemplateOutlet]="orderContent"></ng-container>
      <div class="modal-action mt-6">
        <button class="btn btn-primary" (click)="close()">Close</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button (click)="close()">close</button>
    </form>
  </dialog>
}

<div class="space-y-4 sm:space-y-6" [class.print-mode]="isPrintMode()">
  <!-- Header (hidden in print mode and modal mode) -->
  @if (showHeader() && !modalMode()) {
    <div class="no-print">
      <div class="flex items-center justify-between mb-6">
        <div>
          <button (click)="goBack()" class="btn btn-ghost btn-sm mb-2">‚Üê Back to Orders</button>
          <h1 class="text-3xl font-bold">Order {{ order()?.code || '' }}</h1>
        </div>
        @if (showPrintControls()) {
          <div class="flex gap-2">
            @if (canPrint()) {
              <select
                class="select select-bordered"
                [value]="selectedTemplate()"
                (change)="selectedTemplate.set($any($event.target).value)"
              >
                @for (template of templates; track template.id) {
                  <option [value]="template.id">{{ template.name }}</option>
                }
              </select>
              <button class="btn btn-primary" (click)="handlePrint()" [disabled]="!order()">
                üñ®Ô∏è Print
              </button>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Error Alert -->
  @if (error()) {
    <div role="alert" class="alert alert-error shadow-lg" [class.no-print]="!modalMode()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="flex-1">{{ error() }}</span>
      <button (click)="clearError()" class="btn btn-sm">Dismiss</button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm text-base-content/60 mt-4">Loading order...</p>
        </div>
      </div>
    </div>
  }

  <!-- Order Details -->
  @if (order()) {
    <ng-container [ngTemplateOutlet]="orderDetailsContent"></ng-container>
  }
</div>

<!-- Order Details Content Template (shared) -->
<ng-template #orderDetailsContent>
  <div class="space-y-4 sm:space-y-6">
    <!-- Order Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300/60">
      <div class="card-body p-4 sm:p-6">
        <app-order-detail-header
          [orderCode]="order()!.code"
          [orderState]="order()!.state"
          [orderDate]="order()!.orderPlacedAt || order()!.createdAt"
        />
      </div>
    </div>

    <!-- Mobile: Expansion Panels -->
    <div class="lg:hidden space-y-3">
      <!-- Customer & Billing Address Expansion Panel -->
      <div
        class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
      >
        <input type="checkbox" />
        <div class="collapse-title text-base font-semibold px-4 py-3">
          <div class="flex items-center justify-between">
            <span>{{ customerName() }}</span>
            <span class="text-xs font-normal text-base-content/50">Customer</span>
          </div>
        </div>
        <div class="collapse-content px-4 pb-4">
          <div class="space-y-4 pt-2">
            <!-- Customer Info -->
            <app-order-customer-info [customer]="order()!.customer" />

            <!-- Billing Address -->
            <div class="pt-3 border-t border-base-300/50">
              <app-order-address
                [address]="order()!.billingAddress"
                [label]="'Billing Address'"
                [fallbackName]="customerName()"
              />
            </div>

            <!-- Shipping Address (if exists) -->
            @if (hasShipping() && order()!.shippingAddress) {
              <div class="pt-3 border-t border-base-300/50">
                <app-order-address
                  [address]="order()!.shippingAddress"
                  [label]="'Shipping Address'"
                  [fallbackName]="customerName()"
                />
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Payment Information Expansion Panel -->
      <div
        class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
      >
        <input type="checkbox" />
        <div class="collapse-title text-base font-semibold px-4 py-3">Payment Information</div>
        <div class="collapse-content px-4 pb-4">
          <app-order-payment-info [payments]="order()!.payments" />
          @if (showPayOrderButton()) {
            <div class="divider my-3"></div>
            <div class="space-y-2">
              @if (paymentError()) {
                <div class="alert alert-error alert-sm">
                  <span>{{ paymentError() }}</span>
                  <button class="btn btn-ghost btn-xs" (click)="paymentError.set(null)">‚úï</button>
                </div>
              }
              @if (paymentSuccess()) {
                <div class="alert alert-success alert-sm">
                  <span>{{ paymentSuccess() }}</span>
                </div>
              }
              <button
                class="btn btn-primary btn-sm w-full"
                [disabled]="isProcessingPayment()"
                (click)="handlePayOrder()"
              >
                @if (isProcessingPayment()) {
                  <span class="loading loading-spinner loading-xs"></span>
                  Processing...
                } @else {
                  üí≥ Pay Order
                  @if (outstandingAmount() > 0) {
                    ({{ currencyService.format(outstandingAmount() * 100) }})
                  }
                }
              </button>
            </div>
          }
        </div>
      </div>

      <!-- Fulfillment Information Expansion Panel -->
      @if (order()!.fulfillments && order()!.fulfillments.length > 0) {
        <div
          class="collapse collapse-arrow bg-base-100 border border-base-300/60 shadow-sm rounded-lg"
        >
          <input type="checkbox" />
          <div class="collapse-title text-base font-semibold px-4 py-3">Fulfillment</div>
          <div class="collapse-content px-4 pb-4">
            <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
          </div>
        </div>
      }
    </div>

    <!-- Desktop: Side-by-side Layout -->
    <div class="hidden lg:grid lg:grid-cols-3 gap-4">
      <!-- Left Column: Customer & Addresses -->
      <div class="space-y-4">
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-4">
            <app-order-customer-info [customer]="order()!.customer" />
            <div class="divider my-3"></div>
            <app-order-address
              [address]="order()!.billingAddress"
              [label]="'Billing Address'"
              [fallbackName]="customerName()"
            />
            @if (hasShipping() && order()!.shippingAddress) {
              <div class="divider my-3"></div>
              <app-order-address
                [address]="order()!.shippingAddress"
                [label]="'Shipping Address'"
                [fallbackName]="customerName()"
              />
            }
          </div>
        </div>

        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-4">
            <app-order-payment-info [payments]="order()!.payments" />
            @if (showPayOrderButton()) {
              <div class="divider my-3"></div>
              <div class="space-y-2">
                @if (paymentError()) {
                  <div class="alert alert-error alert-sm">
                    <span>{{ paymentError() }}</span>
                    <button class="btn btn-ghost btn-xs" (click)="paymentError.set(null)">‚úï</button>
                  </div>
                }
                @if (paymentSuccess()) {
                  <div class="alert alert-success alert-sm">
                    <span>{{ paymentSuccess() }}</span>
                  </div>
                }
                <button
                  class="btn btn-primary btn-sm w-full"
                  [disabled]="isProcessingPayment()"
                  (click)="handlePayOrder()"
                >
                  @if (isProcessingPayment()) {
                    <span class="loading loading-spinner loading-xs"></span>
                    Processing...
                  } @else {
                    üí≥ Pay Order
                    @if (outstandingAmount() > 0) {
                      ({{ currencyService.format(outstandingAmount()) }})
                    }
                  }
                </button>
              </div>
            }
          </div>
        </div>

        @if (order()!.fulfillments && order()!.fulfillments.length > 0) {
          <div class="card bg-base-100 shadow-sm border border-base-300/60">
            <div class="card-body p-4">
              <app-order-fulfillment-info [fulfillments]="order()!.fulfillments" />
            </div>
          </div>
        }
      </div>

      <!-- Right Column: Items & Totals (2 columns) -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Order Items - Prominent -->
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-4 sm:p-6">
            <app-order-items-table [lines]="order()!.lines" />
          </div>
        </div>

        <!-- Totals -->
        <div class="card bg-base-100 shadow-sm border border-base-300/60">
          <div class="card-body p-4 sm:p-6">
            <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile: Items & Totals (Full Width) -->
    <div class="lg:hidden space-y-4">
      <!-- Order Items - Prominent -->
      <div class="card bg-base-100 shadow-sm border border-base-300/60">
        <div class="card-body p-4">
          <app-order-items-table [lines]="order()!.lines" />
        </div>
      </div>

      <!-- Totals -->
      <div class="card bg-base-100 shadow-sm border border-base-300/60">
        <div class="card-body p-4">
          <app-order-totals [subtotal]="subtotal()" [tax]="tax()" [total]="total()" />
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Order Content Template (for modal mode) -->
<ng-template #orderContent>
  <!-- Error Alert (for modal mode) -->
  @if (error()) {
    <div role="alert" class="alert alert-error mb-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 shrink-0"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="flex-1">{{ error() }}</span>
      <button (click)="clearError()" class="btn btn-sm">Dismiss</button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading() && !order()) {
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="flex flex-col items-center justify-center py-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="text-sm text-base-content/60 mt-4">Loading order...</p>
        </div>
      </div>
    </div>
  }

  <!-- Order Details (uses shared template) -->
  @if (order()) {
    <ng-container [ngTemplateOutlet]="orderDetailsContent"></ng-container>
  }
</ng-template>
